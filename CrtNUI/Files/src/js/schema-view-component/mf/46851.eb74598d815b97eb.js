(self.webpackChunkapp_studio_enterprise_schema_view=self.webpackChunkapp_studio_enterprise_schema_view||[]).push([[46851],{46851:(O,_,o)=>{o.r(_),o.d(_,{BaseRelatedInMainRecordsHandler:()=>N,BaseRelatedInMainRecordsService:()=>A,OpenSelectionWindowRequest:()=>S,PAGE_LOOKUP_DATA_TOKEN:()=>C,PAGE_LOOKUP_RESULT_TYPE_DEFAULT_VALUE:()=>F,PageLookupResultType:()=>g,RelatedRecordsActionsEnum:()=>m,SelectionApiMode:()=>v,SelectionWindowResult:()=>V});var E=o(63721),p=o(59131),n=o(38495),L=o(79772),P=o(21018),c=o(28399),h=o(62278),m;(function(i){i[i.AddRelatedRecords=0]="AddRelatedRecords",i[i.RemoveRelatedRecords=1]="RemoveRelatedRecords"})(m||(m={}));class A{constructor(){this._translateService=(0,p.inject)(L.TranslateService),this._httpClient=(0,p.inject)(E.HttpClient),this._userInfo=(0,p.inject)(P.UserInfo)}get _relatedInMainRecordsServiceEndpoint(){return(this._userInfo.isSSP?"ssp/":"")+`rest/${this.relatedInMainRecordsServiceName}/`}_isInvalidParameters(e){return(0,c.isEmpty)(e.relatedRecordsSchemaName)||(0,c.isEmpty)(e.relatedInMainRecordsSchemaName)||(0,c.isEmpty)(e.relatedRecordColumnName)||(0,c.isEmpty)(e.mainRecordColumnName)||!this._isValidFilters(e.relatedRecordsFilters)||!this._isValidFilters(e.mainRecordsFilters)}_isValidFilters(e){return(0,c.isObject)(e)&&"items"in e&&!(0,c.isEmpty)(e.items)}_catchHttpErrorResponse(e){return(0,h.of)({success:!1,message:e.error?.errorInfo?.message??e.message})}_createEsqWithFilters(e,t){const s=new n.EntitySchemaQuery(e);return this._addFiltersToEsq(s,t),s}_addFiltersToEsq(e,t){Object.entries(t.items).forEach(([s,a])=>{e.filters.add(a,s)})}getServiceResultMessage(e,t,s){if(e.success){const a=this.relatedRecordsActionsNames.get(t);return this._translateService.instant(`${this.relatedInMainRecordsServiceName}.ServiceResult.${a}${s}`,{count:(0,c.get)(e,"processedRecordsCount",null)})}return e.errorInfo?.message||this._translateService.instant("BaseRelatedInMainRecordsService.ServiceResult.ErrorMessage")}executeAction(e,t){return this._isInvalidParameters(t)?(0,h.of)({success:!1,message:this._translateService.instant("BaseRelatedInMainRecordsService.NotValidParametersMessage")}):this.process(e,t)}process(e,t){const s=this.createRelatedRecordsEsq(t),a=this.createMainRecordsEsq(t),r=this.createRequest(s,a,t);return this.callService(e,r,t)}createRelatedRecordsEsq(e){return this._createEsqWithFilters(e.relatedRecordsSchemaName,e.relatedRecordsFilters)}createMainRecordsEsq(e){return this._createEsqWithFilters(e.mainRecordsSchemaName,e.mainRecordsFilters)}callService(e,t,s){const a=this.relatedRecordsActionsNames.get(e);return this._httpClient.post(`${this._relatedInMainRecordsServiceEndpoint}${a}`,{request:t}).pipe((0,h.map)(r=>({success:r.success,message:this.getServiceResultMessage(r,e,"Message")})),(0,h.catchError)(r=>this._catchHttpErrorResponse(r)))}addRelatedRecords(e){return this.executeAction(m.AddRelatedRecords,e)}removeRelatedRecords(e){return this.executeAction(m.RemoveRelatedRecords,e)}}var R=o(73308),k=o(59564),y=o(20822);class N extends n.BaseRequestHandler{constructor(e){super(),this.injector=e,this.notifyService=e.get(k.NotifyService),this.maskService=e.get(n.MaskService),this.messageDialogProvider=e.get(y.MessageDialogProvider)}_getOpenLookupPageRequestConfig(e){return{type:"crt.OpenSelectionWindowRequest",$context:e.$context,scopes:e.scopes,features:this.getLookupPageFeatures(),entitySchemaName:this.getLookupPageEntitySchemaName(e),caption:this.getLookupPageCaption(e),filtersConfig:this._getLookupPageFiltersConfig(e),afterClosed:s=>this._afterClosedLookupPageAction(e,s)}}_getLookupPageFiltersConfig(e){const t=this.getLookupPageFilter(e);if(!t)return;const s="lookup_page_filter";return{filterAttributes:[{name:s,loadOnChange:!1}],attributesConfig:{[s]:{value:t}}}}_afterClosedLookupPageAction(e,t){t.canceled||(this.maskService.showMask(this.getMaskTaskName(e),e.$context),this.runServiceAction(e,t.filter).pipe((0,h.tap)(()=>{this.maskService.hideMask(this.getMaskTaskName(e),e.$context)})).subscribe(s=>{this._processServiceResult(e,s)}))}_processServiceResult(e,t){const s={message:t.message,translate:!1};if(t.success){this.showSuccessNotification(e,s);return}this.notifyService.error(s)}_validateRequest(e){return this._validateRequestDataSource(e)&&this._validateRequestFilters(e)}_validateRequestDataSource(e){return e.dataSourceName?!0:(this.messageDialogProvider.open({data:{message:"InfoDialog.SettingsErrorMessage",actions:[y.DEFAULT_DIALOG_ACTIONS.OK]}}),!1)}_validateRequestFilters(e){return this._isValidFilters(e.filters)?!0:(this.notifyService.error({message:this.invalidErrorMessageForSelectRecordsValidator,translate:!0}),!1)}_isValidFilters(e){return(0,c.isObject)(e)&&"items"in e&&!(0,c.isEmpty)(e.items)}getLookupPageFeatures(){return{create:{enabled:!1},select:{multiple:!0,selectAll:!1}}}getLookupPageFilter(e){return null}showSuccessNotification(e,t){this.notifyService.show(t)}getRelatedRecordsSchemaName(e){return e.$context.dataSchemas[e.dataSourceName]?.name}runServiceAction(e,t){const s=this.createServiceData(e,t);return this.openLookupPageMode==="AddRecords"?this.addRecordsServiceAction(s):this.removeRecordsServiceAction(s)}addRecordsServiceAction(e){return this.baseRelatedInMainRecordsService.addRelatedRecords(e)}removeRecordsServiceAction(e){return this.baseRelatedInMainRecordsService.removeRelatedRecords(e)}initializeData(e){}handle(e){var t=this;return(0,R.A)(function*(){if(!t._validateRequest(e))return;yield t.initializeData(e);const s=t._getOpenLookupPageRequestConfig(e);yield t.handlerChain.process(s)})()}}var g;(function(i){i.LookupValues="lookupValues",i.Filter="filter"})(g||(g={}));const F=g.LookupValues;var v;(function(i){i[i.Legacy=0]="Legacy",i[i.New=1]="New"})(v||(v={}));const C=new p.InjectionToken("PageLookupDataToken");class V{get canceled(){return this._canceled}get filter(){return this._filter}constructor(e){this._cachedLookupValues=[],this._entityName=e?.entityName,this._selectionState=e?.selectionState,this._filter=e?.filter,this._cachedLookupValues=e?.cachedLookupValues??[],this._canceled=e?.canceled??!1}_getFilterByPrimaryValues(e,t){const s=new n.EntitySchemaQuery("tempTable"),a=new n.ColumnExpression({columnPath:e}),r=t.map(u=>new n.ParameterExpression({value:u})),l=new n.InFilter(n.ComparisonType.Equal,a,r);return s.filters.add(l),s.getMetadata().filters}_loadLookupValues(e,t,s,a){return(0,R.A)(function*(){const{primaryAttributeName:r,primaryDisplayAttributeName:l,primaryColorAttributeName:d}=t,u=[r,l,d].filter(Boolean);return(yield e.load({attributes:u,parameters:[{type:n.ModelParameterType.Filter,value:s}],options:a?{pagingConfig:a}:{}})).map(f=>({value:f[r],displayValue:f[l],primaryColorValue:f[d]}))})()}_loadLookupValuesByPrimaryValues(e,t){var s=this;return(0,R.A)(function*(){if(!t.length)return[];const a=yield n.Model.create(e),r=yield a.getSchema(),l=s._getFilterByPrimaryValues(r.primaryAttributeName,t);return s._loadLookupValues(a,r,l)})()}_isCached(e){return this._cachedLookupValues.some(t=>t.value===e)}getLookupValues(e){var t=this;return(0,R.A)(function*(){if(!t._selectionState||t.canceled)return[];const s=e?.pagingConfig;if(t._selectionState?.type==="specific"){let a;(0,c.isUndefined)(s?.rowsOffset)||(0,c.isUndefined)(s?.rowCount)?a=[...t._selectionState.selected]:a=t._selectionState.selected.slice(s?.rowsOffset,s?.rowsOffset+s?.rowCount);const r=a.filter(d=>!t._isCached(d)),l=yield t._loadLookupValuesByPrimaryValues(t._entityName,r);return a.map(d=>t._cachedLookupValues.find(u=>u.value===d)||l.find(u=>u.value===d))}else{const a=yield n.Model.create(t._entityName),r=yield a.getSchema();return t._loadLookupValues(a,r,t._filter,s)}})()}}var M=o(5960);let S=class extends n.BaseRequest{};S=(0,M.__decorate)([(0,n.CrtRequest)({type:"crt.OpenSelectionWindowRequest"})],S)}}]);
