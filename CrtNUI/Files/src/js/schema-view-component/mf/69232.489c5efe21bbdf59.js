(self.webpackChunkapp_studio_enterprise_schema_view=self.webpackChunkapp_studio_enterprise_schema_view||[]).push([[69232,73308,50927,28546,6165,62832,40451,18070,95689,94260,71879,41421,63802,86183,8564,30945,53326,75707,98088,20469,42850,70422,48041,15184,92803,80898,58517,25660,3279,91374,68993,83231,46851],{46851:(N,_,c)=>{c.r(_),c.d(_,{BaseRelatedInMainRecordsHandler:()=>F,BaseRelatedInMainRecordsService:()=>R,OpenSelectionWindowRequest:()=>A,PAGE_LOOKUP_DATA_TOKEN:()=>V,PAGE_LOOKUP_RESULT_TYPE_DEFAULT_VALUE:()=>C,PageLookupResultType:()=>L,RelatedRecordsActionsEnum:()=>d,SelectionApiMode:()=>P,SelectionWindowResult:()=>M});var y=c(63721),f=c(59131),i=c(38495),g=c(79772),S=c(21018),o=c(28399),l=c(62278),d;(function(n){n[n.AddRelatedRecords=0]="AddRelatedRecords",n[n.RemoveRelatedRecords=1]="RemoveRelatedRecords"})(d||(d={}));class R{constructor(){this._translateService=(0,f.inject)(g.TranslateService),this._httpClient=(0,f.inject)(y.HttpClient),this._userInfo=(0,f.inject)(S.UserInfo)}get _relatedInMainRecordsServiceEndpoint(){return(this._userInfo.isSSP?"ssp/":"")+`rest/${this.relatedInMainRecordsServiceName}/`}_isInvalidParameters(e){return(0,o.isEmpty)(e.relatedRecordsSchemaName)||(0,o.isEmpty)(e.relatedInMainRecordsSchemaName)||(0,o.isEmpty)(e.relatedRecordColumnName)||(0,o.isEmpty)(e.mainRecordColumnName)||!this._isValidFilters(e.relatedRecordsFilters)||!this._isValidFilters(e.mainRecordsFilters)}_isValidFilters(e){return(0,o.isObject)(e)&&"items"in e&&!(0,o.isEmpty)(e.items)}_catchHttpErrorResponse(e){return(0,l.of)({success:!1,message:e.error?.errorInfo?.message??e.message})}_createEsqWithFilters(e,t){const s=new i.EntitySchemaQuery(e);return this._addFiltersToEsq(s,t),s}_addFiltersToEsq(e,t){Object.entries(t.items).forEach(([s,r])=>{e.filters.add(r,s)})}getServiceResultMessage(e,t,s){if(e.success){const r=this.relatedRecordsActionsNames.get(t);return this._translateService.instant(`${this.relatedInMainRecordsServiceName}.ServiceResult.${r}${s}`,{count:(0,o.get)(e,"processedRecordsCount",null)})}return e.errorInfo?.message||this._translateService.instant("BaseRelatedInMainRecordsService.ServiceResult.ErrorMessage")}executeAction(e,t){return this._isInvalidParameters(t)?(0,l.of)({success:!1,message:this._translateService.instant("BaseRelatedInMainRecordsService.NotValidParametersMessage")}):this.process(e,t)}process(e,t){const s=this.createRelatedRecordsEsq(t),r=this.createMainRecordsEsq(t),a=this.createRequest(s,r,t);return this.callService(e,a,t)}createRelatedRecordsEsq(e){return this._createEsqWithFilters(e.relatedRecordsSchemaName,e.relatedRecordsFilters)}createMainRecordsEsq(e){return this._createEsqWithFilters(e.mainRecordsSchemaName,e.mainRecordsFilters)}callService(e,t,s){const r=this.relatedRecordsActionsNames.get(e);return this._httpClient.post(`${this._relatedInMainRecordsServiceEndpoint}${r}`,{request:t}).pipe((0,l.map)(a=>({success:a.success,message:this.getServiceResultMessage(a,e,"Message")})),(0,l.catchError)(a=>this._catchHttpErrorResponse(a)))}addRelatedRecords(e){return this.executeAction(d.AddRelatedRecords,e)}removeRelatedRecords(e){return this.executeAction(d.RemoveRelatedRecords,e)}}var u=c(73308),h=c(59564),E=c(20822);class F extends i.BaseRequestHandler{constructor(e){super(),this.injector=e,this.notifyService=e.get(h.NotifyService),this.maskService=e.get(i.MaskService),this.messageDialogProvider=e.get(E.MessageDialogProvider)}_getOpenLookupPageRequestConfig(e){return{type:"crt.OpenSelectionWindowRequest",$context:e.$context,scopes:e.scopes,features:this.getLookupPageFeatures(),entitySchemaName:this.getLookupPageEntitySchemaName(e),caption:this.getLookupPageCaption(e),filtersConfig:this._getLookupPageFiltersConfig(e),afterClosed:s=>this._afterClosedLookupPageAction(e,s)}}_getLookupPageFiltersConfig(e){const t=this.getLookupPageFilter(e);if(!t)return;const s="lookup_page_filter";return{filterAttributes:[{name:s,loadOnChange:!1}],attributesConfig:{[s]:{value:t}}}}_afterClosedLookupPageAction(e,t){t.canceled||(this.maskService.showMask(this.getMaskTaskName(e),e.$context),this.runServiceAction(e,t.filter).pipe((0,l.tap)(()=>{this.maskService.hideMask(this.getMaskTaskName(e),e.$context)})).subscribe(s=>{this._processServiceResult(e,s)}))}_processServiceResult(e,t){const s={message:t.message,translate:!1};if(t.success){this.showSuccessNotification(e,s);return}this.notifyService.error(s)}_validateRequest(e){return this._validateRequestDataSource(e)&&this._validateRequestFilters(e)}_validateRequestDataSource(e){return e.dataSourceName?!0:(this.messageDialogProvider.open({data:{message:"InfoDialog.SettingsErrorMessage",actions:[E.DEFAULT_DIALOG_ACTIONS.OK]}}),!1)}_validateRequestFilters(e){return this._isValidFilters(e.filters)?!0:(this.notifyService.error({message:this.invalidErrorMessageForSelectRecordsValidator,translate:!0}),!1)}_isValidFilters(e){return(0,o.isObject)(e)&&"items"in e&&!(0,o.isEmpty)(e.items)}getLookupPageFeatures(){return{create:{enabled:!1},select:{multiple:!0,selectAll:!1}}}getLookupPageFilter(e){return null}showSuccessNotification(e,t){this.notifyService.show(t)}getRelatedRecordsSchemaName(e){return e.$context.dataSchemas[e.dataSourceName]?.name}runServiceAction(e,t){const s=this.createServiceData(e,t);return this.openLookupPageMode==="AddRecords"?this.addRecordsServiceAction(s):this.removeRecordsServiceAction(s)}addRecordsServiceAction(e){return this.baseRelatedInMainRecordsService.addRelatedRecords(e)}removeRecordsServiceAction(e){return this.baseRelatedInMainRecordsService.removeRelatedRecords(e)}initializeData(e){}handle(e){var t=this;return(0,u.A)(function*(){if(!t._validateRequest(e))return;yield t.initializeData(e);const s=t._getOpenLookupPageRequestConfig(e);yield t.handlerChain.process(s)})()}}var L;(function(n){n.LookupValues="lookupValues",n.Filter="filter"})(L||(L={}));const C=L.LookupValues;var P;(function(n){n[n.Legacy=0]="Legacy",n[n.New=1]="New"})(P||(P={}));const V=new f.InjectionToken("PageLookupDataToken");class M{get canceled(){return this._canceled}get filter(){return this._filter}constructor(e){this._cachedLookupValues=[],this._entityName=e?.entityName,this._selectionState=e?.selectionState,this._filter=e?.filter,this._cachedLookupValues=e?.cachedLookupValues??[],this._canceled=e?.canceled??!1}_getFilterByPrimaryValues(e,t){const s=new i.EntitySchemaQuery("tempTable"),r=new i.ColumnExpression({columnPath:e}),a=t.map(v=>new i.ParameterExpression({value:v})),m=new i.InFilter(i.ComparisonType.Equal,r,a);return s.filters.add(m),s.getMetadata().filters}_loadLookupValues(e,t,s,r){return(0,u.A)(function*(){const{primaryAttributeName:a,primaryDisplayAttributeName:m,primaryColorAttributeName:p}=t,v=[a,m,p].filter(Boolean);return(yield e.load({attributes:v,parameters:[{type:i.ModelParameterType.Filter,value:s}],options:r?{pagingConfig:r}:{}})).map(k=>({value:k[a],displayValue:k[m],primaryColorValue:k[p]}))})()}_loadLookupValuesByPrimaryValues(e,t){var s=this;return(0,u.A)(function*(){if(!t.length)return[];const r=yield i.Model.create(e),a=yield r.getSchema(),m=s._getFilterByPrimaryValues(a.primaryAttributeName,t);return s._loadLookupValues(r,a,m)})()}_isCached(e){return this._cachedLookupValues.some(t=>t.value===e)}getLookupValues(e){var t=this;return(0,u.A)(function*(){if(!t._selectionState||t.canceled)return[];const s=e?.pagingConfig;if(t._selectionState?.type==="specific"){let r;(0,o.isUndefined)(s?.rowsOffset)||(0,o.isUndefined)(s?.rowCount)?r=[...t._selectionState.selected]:r=t._selectionState.selected.slice(s?.rowsOffset,s?.rowsOffset+s?.rowCount);const a=r.filter(p=>!t._isCached(p)),m=yield t._loadLookupValuesByPrimaryValues(t._entityName,a);return r.map(p=>t._cachedLookupValues.find(v=>v.value===p)||m.find(v=>v.value===p))}else{const r=yield i.Model.create(t._entityName),a=yield r.getSchema();return t._loadLookupValues(r,a,t._filter,s)}})()}}var O=c(5960);let A=class extends i.BaseRequest{};A=(0,O.__decorate)([(0,i.CrtRequest)({type:"crt.OpenSelectionWindowRequest"})],A)},73308:(N,_,c)=>{c.d(_,{A:()=>f});function y(i,g,S,o,l,d,R){try{var u=i[d](R),h=u.value}catch(E){S(E);return}u.done?g(h):Promise.resolve(h).then(o,l)}function f(i){return function(){var g=this,S=arguments;return new Promise(function(o,l){var d=i.apply(g,S);function R(h){y(d,o,l,R,u,"next",h)}function u(h){y(d,o,l,R,u,"throw",h)}R(void 0)})}}}}]);
