(self.webpackChunkapp_studio_enterprise_schema_view=self.webpackChunkapp_studio_enterprise_schema_view||[]).push([[59776],{59776:(xe,me,p)=>{p.r(me),p.d(me,{BaseDataGridColumnEditHandler:()=>P,BaseDataGridStateHandlerService:()=>Z,BooleanCellViewElementConfigCreator:()=>z,BooleanEditingCellViewElementConfigCreator:()=>L,CAN_CREATE_DEFAULT_GRID_SETTING_OPERATION_CODE:()=>Ie,CHECK_DATA_GRID_COLUMNS_RIGHTS_ON_LOAD:()=>fe,CellViewElementConfigCreator:()=>C,CrtDataGridCdkModule:()=>oe,DATA_GRID_AVAILABLE_EDITING_DATA_VALUE_TYPES:()=>ye,DATA_GRID_CELL_VIEW_CONFIG_CREATOR_FACTORY:()=>ae,DATA_GRID_CELL_VIEW_CONFIG_CREATOR_FACTORY_PROVIDER:()=>Fe,DATA_GRID_EDITING_CELL_VIEW_CONFIG_CREATOR_FACTORY:()=>pe,DATA_GRID_EDITING_CELL_VIEW_CONFIG_CREATOR_FACTORY_PROVIDER:()=>be,DISABLE_DATA_GRID_EDITING_MODE_FEATURE_CODE:()=>Se,DISABLE_DATA_GRID_MULTIPLE_ROWS_SELECTION_FEATURE_CODE:()=>Ae,DataGridCancelItemsChangesHandler:()=>ne,DataGridCancelItemsChangesRequest:()=>le,DataGridColumnDefinitionService:()=>q,DataGridRowDoubleClickHandler:()=>ie,DataGridRowDoubleClickRequest:()=>ue,DateTimeCellViewElementConfigCreator:()=>B,DateTimeEditingCellViewElementConfigCreator:()=>G,DcmStageCellViewElementConfigCreator:()=>F,DcmStageEditingCellViewElementConfigCreator:()=>w,EditingCellViewElementConfigCreator:()=>_,EmailCellViewElementConfigCreator:()=>A,EmailEditingCellViewElementConfigCreator:()=>M,FILE_LIST_CELL_VIEW_CONFIG_CREATOR_FACTORY:()=>he,FILE_LIST_CELL_VIEW_CONFIG_CREATOR_FACTORY_PROVIDER:()=>Re,FileCellViewElementConfigCreator:()=>I,FileSizeCellViewElementConfigCreator:()=>v,LookupCellViewElementConfigCreator:()=>X,LookupEditingCellViewElementConfigCreator:()=>N,NativeLinkCellViewElementConfigCreator:()=>Y,NumericCellViewElementConfigCreator:()=>k,NumericEditingCellViewElementConfigCreator:()=>R,PhoneCellViewElementConfigCreator:()=>S,PhoneEditingCellViewElementConfigCreator:()=>O,PrimaryCellViewElementConfigCreator:()=>H,RichTextCellViewElementConfigCreator:()=>V,SchemaDataGridColumnEditHandler:()=>ee,SchemaDataGridColumnSelectionService:()=>te,StructureExplorerDataGridColumnSelectionService:()=>Q,TextCellViewElementConfigCreator:()=>j,TextEditingCellViewElementConfigCreator:()=>b,WebEditingCellViewElementConfigCreator:()=>$});var i=p(59131),D=p(20822),T=p(47742),x=p(22438),m=p(62278),g=p(36486);class Z{get viewModel$(){return this.injector?this.injector.get(T.BINDING_CONTEXT).viewModel$.pipe((0,g.take)(1)):(0,m.of)(null)}constructor(e){this.schemaService=e}getColumnsFromSchema(e){const t=e?.columns??[];if(typeof t=="string"){const a=t.split("$").pop();return this.viewModel$.pipe((0,g.map)(r=>(r?.attributes??{})[a]||[]))}return(0,m.of)(t)}getDataSourceName(e){const t=(0,D.getViewModelItemsAttributeName)(e);return this.viewModel$.pipe((0,g.map)(a=>a?.getBoundDataSourceNameByAttributePath(t)))}handle(e,t){this.injector=t;const a=t.get(T.VIEW_ELEMENT_CONFIG),r=this.schemaService.getViewConfigInfoByName(a.name).viewConfig,n=e.columns??[];return this.getDataSourceName(r).pipe((0,g.switchMap)(s=>s?this.getColumnsFromSchema(r).pipe((0,g.switchMap)(c=>{const d={viewElementConfig:r,dataSourceName:s,columns:n,previousColumns:c};return this.innerHandle(d)})):(0,m.of)(void 0)))}static{this.\u0275fac=function(t){return new(t||Z)(i.\u0275\u0275inject(x.SchemaService))}}static{this.\u0275prov=i.\u0275\u0275defineInjectable({token:Z,factory:Z.\u0275fac})}}var u=p(73308),o=p(38495),ge=p(79772),De=p(47258),h=p(21018),E=p(28399);class P{constructor(e){this._translateService=e.get(ge.TranslateService),this._columnEditService=e.get(D.DataGridColumnEditService),this._entitySchemaService=e.get(h.EntitySchemaService),this._entitySchemaProvider=e.get(h.EntitySchemaProvider),this.schemaService=e.get(x.SchemaService)}_replaceColumn(e,t,a){if(!e)return a;const r=(0,E.findIndex)(a,n=>n.id===t);return a[r]={...e,changed:!0},a}_getEntitySchemaName(e,t){if(!e)return null;const r=t.getBoundDataSchemaByAttributePath(e)?.dataSourceConfig;return r?.type!=="crt.EntityDataSource"?null:r.config?.entitySchemaName}getResources(e,t){return Promise.resolve(this.schemaService.resources)}processColumns(e,t,a){var r=this;return(0,u.A)(function*(){const n=yield r.getResources(e,t),s=(0,D.getDataGridItemsAttributeName)(e),c=r._getEntitySchemaName(s,t);for(const d of a)yield r._setColumnModelProperties(d,t,c,s),r.setColumnCaptionResources(d,n,e);return{dataSourceSchemaName:c,columns:a}})()}_setColumnModelProperties(e,t,a,r){var n=this;return(0,u.A)(function*(){if(!r||!a||!e.code)return;const s=`${r}.${e.code}`,c=t.getBoundDataSchemaAttributeByAttributePath(s);if(!c?.path||c.attributeType!==o.DataSchemaAttributeType.AggregationAttribute)return;const d=yield n.getEntitySchemaNameByPath(a,c.path);e.path=c.path,e.aggregationConfig=c.aggregationConfig||e.aggregationConfig,e.referenceSchemaName=d||e.referenceSchemaName})()}_processColumnOriginalCaption(e,t){const a=t.path,r=a?.startsWith("[")?t.referenceSchemaName:e;return!a||!r||!t.aggregationConfig?(0,m.of)(t):this._entitySchemaProvider.getSchemaByName(r).pipe((0,g.switchMap)(n=>this._entitySchemaService.getEntitySchemaColumnsInformationByPath(n.uId,a," > ")),(0,g.map)(n=>{let s=n.columnCaptionPath;const c=t.aggregationConfig?.aggregationFunction;return c&&(s=this._getAggregationColumnOriginalCaption(s,t.dataValueType,c)),t.originalCaption=s,t}))}_getAggregationColumnOriginalCaption(e,t,a){const r=(0,De.getAllowedAggregationFunctionsByDataValueType)(t);r.push({func:o.AggregationFunction.Count,captionResource:"Count"});const n=r.find(c=>c.func===a)?.captionResource||"",s=this._getAggregationFunctionCaption(n);return a===o.AggregationFunction.TopOne?this._translateService.currentLang===h.DEFAULT_CULTURE_NAME?`${e} (the ${s.toLowerCase()})`:`${e} (${s.toLowerCase()})`:a===o.AggregationFunction.Count?`${e.split(" > ").slice(0,-1).join(" > ")} ${s}`:`${e} ${s}`}_getAggregationFunctionCaption(e){return this._translateService.instant("AggregationNames."+e)}onColumnPreparationFinished(){}handle(e,t,a){const r=a.get(T.VIEW_ELEMENT_CONFIG),n=this.schemaService.getViewConfigInfoByName(r.name).viewConfig;return a.get(T.BINDING_CONTEXT).viewModel$.pipe((0,g.take)(1)).pipe((0,g.mergeMap)(d=>this.processColumns(n,d,t)),(0,g.mergeMap)(d=>{const f=(0,E.cloneDeep)(d.columns.find(y=>y.id===e));return this._processColumnOriginalCaption(d.dataSourceSchemaName,f).pipe((0,m.tap)(()=>this.onColumnPreparationFinished()),(0,g.mergeMap)(y=>this._columnEditService.edit(y,a).pipe((0,g.map)(K=>this._replaceColumn(K,e,d.columns)))))}))}static{this.\u0275fac=function(t){return new(t||P)(i.\u0275\u0275inject(i.Injector))}}static{this.\u0275prov=i.\u0275\u0275defineInjectable({token:P,factory:P.\u0275fac})}}var _e=p(30478),se=p(96590),Te=p(50456),Ee=p(52874);const ae=new i.InjectionToken("A cell view config factory"),pe=new i.InjectionToken("A factory of editing cell view config creators"),he=new i.InjectionToken("A cell view config factory");class Q{constructor(e,t,a,r){this.structureExplorer=e,this.schemaService=t,this.cellViewConfigCreatorFactory=a,this.translateService=r}_openStructureExplorer(e){return this.structureExplorer.show({providers:[e],enableMultiSelection:!0,collectDrillDownItems:!0})}_getColumnCaptionResourceMacros(e,t){const a=t.split(".").join("");return`#ResourceString(${e}_${a})#`}_getStructureExplorerDataProviderConfig(e,t){const a=e.getBoundDataSourceNameByAttributePath(t);return{name:Te.DATA_SOURCE_STRUCTURE_EXPLORER_DATA_PROVIDER_NAME,navigateOnlyThroughDataSource:a,options:{useBackwards:!0}}}_modifyAggregationColumnCode(e,t){return e+t+Ee.Guid.create().toString().slice(0,8)}createColumnDefinition(e){const{structureExplorerItem:t,dataSourceName:a}=e,r=this.getColumnName(t.columnPath),n=t.data?.item?.aggregationFunction;let s=`${a}_${r}`;n&&(s=this._modifyAggregationColumnCode(s,n));const c=t.data.dataValueType,d=n?this.getAggregationColumnCaption(t.caption,t.data.item.aggregationFunctionCaption,t.data.item.aggregationFunction):this._getColumnCaptionResourceMacros(a,r),f=t.data.isMasked,y={id:(0,o.generateGuid)(),code:s,path:t.columnPath,caption:d,dataValueType:c,referenceSchemaName:t.data?.item?.referenceSchemaName,isMasked:f};return n&&(y.aggregationConfig={aggregationFunction:t.data?.item?.aggregationFunction},n===o.AggregationFunction.TopOne&&(y.aggregationConfig.sortByColumn="Id",y.aggregationConfig.sortByDirection=o.OrderDirection.Asc),y.captionResources=new h.LocalizableStringArray,y.captionResources.setValueLocalizableString(this.translateService.currentLang,this.getAggregationColumnCaption(t.caption,t.data.item.aggregationFunctionCaption,t.data.item.aggregationFunction)),y.captionResourcesChanged=!0),{...y}}getItemsAttributeName(e){const t=e.get(T.VIEW_ELEMENT_CONFIG),a=this.schemaService.getViewConfigInfoByName(t.name).viewConfig;return(0,D.getViewModelItemsAttributeName)(a)}getAggregationColumnCaption(e,t,a){return a===o.AggregationFunction.TopOne?this.translateService.currentLang===h.DEFAULT_CULTURE_NAME?`${e} (the ${t.toLowerCase()})`:`${e} (${t.toLowerCase()})`:`${e} ${t}`}getColumnName(e){return(0,h.removeSpecialSymbols)(e)}selectColumns(e){const a=e.get(T.BINDING_CONTEXT).viewModel$.pipe((0,g.take)(1)),r=this.getItemsAttributeName(e);if(!r)return(0,m.of)([]);const n=a.pipe((0,g.map)(c=>c?.getBoundDataSourceNameByAttributePath(r))),s=a.pipe((0,g.map)(c=>this._getStructureExplorerDataProviderConfig(c,r)),(0,g.switchMap)(c=>this._openStructureExplorer(c)));return(0,m.forkJoin)([s,n]).pipe((0,g.map)(([c,d])=>(c??[]).filter(f=>f.id!==d).map(f=>this.createColumnDefinition({structureExplorerItem:f,dataSourceName:d}))))}static{this.\u0275fac=function(t){return new(t||Q)(i.\u0275\u0275inject(_e.StructureExplorerService),i.\u0275\u0275inject(x.SchemaService),i.\u0275\u0275inject(ae),i.\u0275\u0275inject(ge.TranslateService))}}static{this.\u0275prov=i.\u0275\u0275defineInjectable({token:Q,factory:Q.\u0275fac})}}class C{constructor(){this.type=""}getDisplayValue(e){const{column:t,itemsAttributeName:a}=e??{};return`${a}.${t?.code}`}getInitialViewElementConfig(e){const{column:t}=e??{};return{column:{...t},value:this.getDisplayValue(e),type:this.type}}getViewElementConfig(e){return Promise.resolve(this.getInitialViewElementConfig(e))}}class j extends C{constructor(){super(...arguments),this.type="crt.TableTextCell"}static{this.\u0275fac=(()=>{let e;return function(a){return(e||(e=i.\u0275\u0275getInheritedFactory(j)))(a||j)}})()}static{this.\u0275prov=i.\u0275\u0275defineInjectable({token:j,factory:j.\u0275fac,providedIn:"root"})}}class B extends C{constructor(){super(...arguments),this.type="crt.TableDateTimeCell"}static{this.\u0275fac=(()=>{let e;return function(a){return(e||(e=i.\u0275\u0275getInheritedFactory(B)))(a||B)}})()}static{this.\u0275prov=i.\u0275\u0275defineInjectable({token:B,factory:B.\u0275fac,providedIn:"root"})}}class k extends C{constructor(){super(...arguments),this.type="crt.TableNumericCell"}static{this.\u0275fac=(()=>{let e;return function(a){return(e||(e=i.\u0275\u0275getInheritedFactory(k)))(a||k)}})()}static{this.\u0275prov=i.\u0275\u0275defineInjectable({token:k,factory:k.\u0275fac,providedIn:"root"})}}var U=p(10850);class W extends C{constructor(){super(),this.type="crt.Link"}hasSectionEditPage(e){var t=this;return(0,u.A)(function*(){const a=yield t.getReferenceSchemaName(e),r={type:"crt.7XRequest",action:"HasEntityEditPage",$context:e.context,payload:{entityName:a}};return yield o.HandlerChainService.instance.process(r)})()}getDefaultViewElementConfig(e){return Promise.resolve(null)}getViewElementConfig(e){var t=this;return(0,u.A)(function*(){return(yield t.hasSectionEditPage(e))?t.getLinkViewElementConfig(e):t.getDefaultViewElementConfig(e)})()}static{this.\u0275fac=function(t){return new(t||W)}}static{this.\u0275prov=i.\u0275\u0275defineInjectable({token:W,factory:W.\u0275fac})}}class H extends W{constructor(){super()}getReferenceSchemaName(e){return(0,u.A)(function*(){const t=e?.primaryAttributeName??"";return(yield(0,U.getEntitySchemaAttribute)(e.context,e.itemsAttributeName.substring(1)+"."+t))?.referenceSchemaName})()}getLinkViewElementConfig(e){var t=this;return(0,u.A)(function*(){const{itemsAttributeName:a,primaryAttributeName:r,column:n}=e,s=t.getDisplayValue(e);return{column:n,caption:s,type:t.type,href:`${a}.${r} | crt.ToRecordLinkAsync : '${r}'`,mode:"preventDefault",clicked:{request:"crt.UpdateRecordRequest",params:{itemsAttributeName:a.slice(1),recordId:`${a}.${r}`}}}})()}static{this.\u0275fac=function(t){return new(t||H)}}static{this.\u0275prov=i.\u0275\u0275defineInjectable({token:H,factory:H.\u0275fac,providedIn:"root"})}}var re=p(85638);class X extends W{constructor(e,t,a){super(),this._featureService=e,this._entitySchemaRepository=t,this._dcmSchemaManagerService=a,this._colorizedSchemasMap=new Map,this.type="crt.Link"}_isColumnColorized(e){var t=this;return(0,u.A)(function*(){const a=yield(0,m.lastValueFrom)(t._featureService.getFeatureState("DisableDataGridColoredCell")),r=yield t.getReferenceSchemaName(e);if(!r||a)return Promise.resolve(!1);const n=t._colorizedSchemasMap.get(r);return n!==void 0?n:(0,m.lastValueFrom)(t._entitySchemaRepository.getSchemaByName(r).pipe((0,m.map)(s=>{const c=!!s.getPrimaryColorColumn();return t._colorizedSchemasMap.set(r,c),c}),(0,m.catchError)(()=>(0,m.of)(!1))))})()}_decorateConfigWithColorization(e,t){const a=super.getDisplayValue(t);e.type="crt.TableColoredCell",e.displayValue=a}_isStageColumn(e){var t=this;return(0,u.A)(function*(){const a=yield(0,m.lastValueFrom)(t._featureService.getFeatureState("DisableDataGridProgressBarStageCell"));if(!e.dataGridSchemaName||a)return Promise.resolve(!1);const r=yield(0,m.firstValueFrom)(t._entitySchemaRepository.getSchemaByName(e.dataGridSchemaName)),n=(yield(0,m.firstValueFrom)(t._dcmSchemaManagerService.getDcmSchemaDataCollection())).find(c=>c.entitySchemaUId===r.uId&&c.isActive&&c.isActiveVersion);if(!n)return Promise.resolve(!1);const s=r.columns?.find(c=>c.uId===n.stageColumnUId)?.name;return s?e.column.code.split("_").pop()===s:Promise.resolve(!1)})()}_decorateConfigWithSlider(e,t){const a=`${t.dataGridName}_DCMData`;e.type="crt.TableSliderCell";const r=t.column?.code??"",s=`${`${t.itemsAttributeName}.${r}`} | crt.ToEntityStageDataTableSliderConverterAsync:$${a}`;e.percentage=`${s} | crt.ToObjectProp : 'value'`,e.color=`${s} | crt.ToObjectProp : 'color'`,e.value=this.getDisplayValue(t)}getDisplayValue(e){return`${super.getDisplayValue(e)} | crt.ToObjectProp : 'displayValue'`}getReferenceSchemaName(e){return(0,u.A)(function*(){const t=e?.column.code??"";return(yield(0,U.getEntitySchemaAttribute)(e.context,e.itemsAttributeName.substring(1)+"."+t))?.referenceSchemaName})()}getDefaultViewElementConfig(e){var t=()=>super.getInitialViewElementConfig,a=this;return(0,u.A)(function*(){let r=t().call(a,e);const n=yield a._isColumnColorized(e),s=yield a._isStageColumn(e),c=e.column.code.startsWith(U.DYNAMIC_DATA_SOURCE_PREFIX);return s&&!c?a._decorateConfigWithSlider(r,e):n?a._decorateConfigWithColorization(r,e):r=null,r})()}getLinkViewElementConfig(e){var t=this;return(0,u.A)(function*(){const{itemsAttributeName:a,column:r}=e,n=t.getDisplayValue(e),s=yield t.getReferenceSchemaName(e),c=r?.code??"",d=`${a}.${c} | crt.ToObjectProp : 'value' | crt.ToRecordLinkAsync : '${c}'`,f={type:"crt.Link",column:{...r},caption:n,href:d,mode:"preventDefault",clicked:{request:"crt.UpdateRecordRequest",params:{entityName:s,recordId:`${a}.${c} | crt.ToObjectProp : "value"`}}},y=yield t._isColumnColorized(e),K=yield t._isStageColumn(e),ce=e.column.code.startsWith(U.DYNAMIC_DATA_SOURCE_PREFIX);return K&&!ce?t._decorateConfigWithSlider(f,e):y&&t._decorateConfigWithColorization(f,e),f})()}static{this.\u0275fac=function(t){return new(t||X)(i.\u0275\u0275inject(re.FeatureService),i.\u0275\u0275inject(h.EntitySchemaRepository),i.\u0275\u0275inject(re.DcmSchemaManagerService))}}static{this.\u0275prov=i.\u0275\u0275defineInjectable({token:X,factory:X.\u0275fac,providedIn:"root"})}}class z extends C{constructor(e){super(),this._defaultFeatures=e,this.type="crt.TableBooleanCell"}_getEditingModeDisabledExpression(e){if((0,x.isBindingExpression)(e))return`${e} | crt.PickDataGridFeatureValue : 'editable.enable' | crt.InvertBooleanValue`;const t=(0,D.fullInDataTableEditingFeatures)(e?.editable,!0);return!(0,D.fullInDataTableEditingFeatures)(this._defaultFeatures?.editable,!1).enable||!t.enable}getViewElementConfig(e){var t=()=>super.getViewElementConfig,a=this;return(0,u.A)(function*(){const r=yield t().call(a,e),n=a.getDisplayValue(e),s=e.column.readonly===!0,c=a._getEditingModeDisabledExpression(e.features);return{...r,control:n,readonly:s||c,bindTo:n,readiness:`$${U.BUSINESS_RULES_ACTIVATED_SYSTEM_ATTRIBUTE_NAME}`}})()}static{this.\u0275fac=function(t){return new(t||z)(i.\u0275\u0275inject(D.DATA_GRID_FEATURES,8))}}static{this.\u0275prov=i.\u0275\u0275defineInjectable({token:z,factory:z.\u0275fac,providedIn:"root"})}}class S extends C{constructor(){super(...arguments),this.type="crt.TablePhoneCell"}static{this.\u0275fac=(()=>{let e;return function(a){return(e||(e=i.\u0275\u0275getInheritedFactory(S)))(a||S)}})()}static{this.\u0275prov=i.\u0275\u0275defineInjectable({token:S,factory:S.\u0275fac,providedIn:"root"})}}class A extends C{constructor(){super(...arguments),this.type="crt.TableEmailCell"}static{this.\u0275fac=(()=>{let e;return function(a){return(e||(e=i.\u0275\u0275getInheritedFactory(A)))(a||A)}})()}static{this.\u0275prov=i.\u0275\u0275defineInjectable({token:A,factory:A.\u0275fac,providedIn:"root"})}}class I extends C{constructor(){super(...arguments),this.type="crt.TableFileCell"}getViewElementConfig(e){var t=this;return(0,u.A)(function*(){const{itemsAttributeName:a,primaryAttributeName:r,dataSchemaName:n,column:s}=e;return{column:{...s},fileName:t.getDisplayValue(e),fileUrl:`${a}.${r} | crt.ToFileLink : '${n}'`,type:t.type}})()}static{this.\u0275fac=(()=>{let e;return function(a){return(e||(e=i.\u0275\u0275getInheritedFactory(I)))(a||I)}})()}static{this.\u0275prov=i.\u0275\u0275defineInjectable({token:I,factory:I.\u0275fac,providedIn:"root"})}}class v extends C{constructor(){super(...arguments),this.type="crt.TableFileSizeCell"}static{this.\u0275fac=(()=>{let e;return function(a){return(e||(e=i.\u0275\u0275getInheritedFactory(v)))(a||v)}})()}static{this.\u0275prov=i.\u0275\u0275defineInjectable({token:v,factory:v.\u0275fac,providedIn:"root"})}}class V extends C{constructor(){super(...arguments),this.type="crt.TableRichTextEditorCell"}static{this.\u0275fac=(()=>{let e;return function(a){return(e||(e=i.\u0275\u0275getInheritedFactory(V)))(a||V)}})()}static{this.\u0275prov=i.\u0275\u0275defineInjectable({token:V,factory:V.\u0275fac,providedIn:"root"})}}class Y extends C{constructor(){super(),this.type="crt.Link"}getViewElementConfig(e){var t=()=>super.getViewElementConfig,a=this;return(0,u.A)(function*(){const r=yield t().call(a,e),n=e.column.dataValueType===o.DataValueType.EMAIL_TEXT;return r.href=n?`${r.value} | crt.ToEmailLink`:`${r.value} | crt.LinkPrefix`,r.caption=`${r.value}`,r.mode="native",r.target=n?"_self":"_blank",r})()}static{this.\u0275fac=function(t){return new(t||Y)}}static{this.\u0275prov=i.\u0275\u0275defineInjectable({token:Y,factory:Y.\u0275fac,providedIn:"root"})}}class F extends C{constructor(){super(...arguments),this.type="crt.TableDcmStageCell"}getViewElementConfig(e){var t=()=>super.getViewElementConfig,a=this;return(0,u.A)(function*(){const r=yield t().call(a,e),n=a.getDisplayValue(e);return{...r,value:n,bindTo:n,dcmStages:"$DcmStages"}})()}static{this.\u0275fac=(()=>{let e;return function(a){return(e||(e=i.\u0275\u0275getInheritedFactory(F)))(a||F)}})()}static{this.\u0275prov=i.\u0275\u0275defineInjectable({token:F,factory:F.\u0275fac,providedIn:"root"})}}class _{constructor(){this.type=""}getColumnDataSchemaAttribute(e){const{column:t,context:a,itemsAttributeName:r}=e,n=(0,D.getDataGridItemsAttributeName)({items:r});if(!t.code||!n)return null;const s=`${n}.${t.code}`;return a.getBoundDataSchemaAttributeByAttributePath(s)}getViewElementConfig(e){var t=this;return(0,u.A)(function*(){const{column:a,itemsAttributeName:r}=e??{};return{type:t.type,control:`${r}.${a.code}`,bindTo:`${r}.${a.code}`}})()}}class b extends _{constructor(){super(...arguments),this.type="crt.DataTableEditTextCell"}static{this.\u0275fac=(()=>{let e;return function(a){return(e||(e=i.\u0275\u0275getInheritedFactory(b)))(a||b)}})()}static{this.\u0275prov=i.\u0275\u0275defineInjectable({token:b,factory:b.\u0275fac,providedIn:"root"})}}class R extends _{constructor(){super(...arguments),this.type="crt.DataTableEditNumericCell"}static{this.\u0275fac=(()=>{let e;return function(a){return(e||(e=i.\u0275\u0275getInheritedFactory(R)))(a||R)}})()}static{this.\u0275prov=i.\u0275\u0275defineInjectable({token:R,factory:R.\u0275fac,providedIn:"root"})}}class N extends _{constructor(){super(...arguments),this.type="crt.DataTableEditLookupCell"}static{this.\u0275fac=(()=>{let e;return function(a){return(e||(e=i.\u0275\u0275getInheritedFactory(N)))(a||N)}})()}static{this.\u0275prov=i.\u0275\u0275defineInjectable({token:N,factory:N.\u0275fac,providedIn:"root"})}}class G extends _{constructor(){super(...arguments),this._dataValueTypeToDateType=new Map([[o.DataValueType.Date,h.DateTypes.Date],[o.DataValueType.Time,h.DateTypes.Time],[o.DataValueType.DateTime,h.DateTypes.DateTime]]),this.type="crt.DataTableEditDateTimeCell"}getViewElementConfig(e){var t=()=>super.getViewElementConfig,a=this;return(0,u.A)(function*(){const{column:r}=e??{};return{...yield t().call(a,e),dateType:a._dataValueTypeToDateType.get(r.dataValueType)??h.DateTypes.DateTime}})()}static{this.\u0275fac=(()=>{let e;return function(a){return(e||(e=i.\u0275\u0275getInheritedFactory(G)))(a||G)}})()}static{this.\u0275prov=i.\u0275\u0275defineInjectable({token:G,factory:G.\u0275fac,providedIn:"root"})}}class L extends _{getViewElementConfig(e){return(0,u.A)(function*(){return null})()}static{this.\u0275fac=(()=>{let e;return function(a){return(e||(e=i.\u0275\u0275getInheritedFactory(L)))(a||L)}})()}static{this.\u0275prov=i.\u0275\u0275defineInjectable({token:L,factory:L.\u0275fac,providedIn:"root"})}}class O extends _{constructor(){super(...arguments),this.type="crt.DataTableEditPhoneCell"}getViewElementConfig(e){var t=()=>super.getViewElementConfig,a=this;return(0,u.A)(function*(){const r=yield t().call(a,e);if(!e?.context)return r;const n=a.getColumnDataSchemaAttribute(e);return n?{...r,displayAsPhone:n.isMasked}:r})()}static{this.\u0275fac=(()=>{let e;return function(a){return(e||(e=i.\u0275\u0275getInheritedFactory(O)))(a||O)}})()}static{this.\u0275prov=i.\u0275\u0275defineInjectable({token:O,factory:O.\u0275fac,providedIn:"root"})}}class M extends _{constructor(){super(...arguments),this.type="crt.DataTableEditEmailCell"}getViewElementConfig(e){var t=()=>super.getViewElementConfig,a=this;return(0,u.A)(function*(){const r=yield t().call(a,e);if(!e?.context)return r;const n=a.getColumnDataSchemaAttribute(e);return n?{...r,isFormatValidated:n.isFormatValidated}:r})()}static{this.\u0275fac=(()=>{let e;return function(a){return(e||(e=i.\u0275\u0275getInheritedFactory(M)))(a||M)}})()}static{this.\u0275prov=i.\u0275\u0275defineInjectable({token:M,factory:M.\u0275fac,providedIn:"root"})}}class $ extends _{constructor(){super(...arguments),this.type="crt.DataTableEditWebCell"}static{this.\u0275fac=(()=>{let e;return function(a){return(e||(e=i.\u0275\u0275getInheritedFactory($)))(a||$)}})()}static{this.\u0275prov=i.\u0275\u0275defineInjectable({token:$,factory:$.\u0275fac,providedIn:"root"})}}class w extends _{constructor(){super(...arguments),this.type="crt.TableDcmStageEditingCell"}getViewElementConfig(e){var t=()=>super.getViewElementConfig,a=this;return(0,u.A)(function*(){return{...yield t().call(a,e),column:{},dcmStages:"$DcmStages"}})()}static{this.\u0275fac=(()=>{let e;return function(a){return(e||(e=i.\u0275\u0275getInheritedFactory(w)))(a||w)}})()}static{this.\u0275prov=i.\u0275\u0275defineInjectable({token:w,factory:w.\u0275fac,providedIn:"root"})}}const fe="CheckDataGridColumnsRightsOnLoad",Se="DisableDataGridEditingMode",Ae="DisableDataGridMultipleRowsSelection",Ie="CanCreateDefaultGridSettings",ye=[o.DataValueType.Guid,o.DataValueType.Text,o.DataValueType.Integer,o.DataValueType.Float,o.DataValueType.Money,o.DataValueType.DateTime,o.DataValueType.Date,o.DataValueType.Time,o.DataValueType.Lookup,o.DataValueType.Enum,o.DataValueType.Boolean,o.DataValueType.SHORT_TEXT,o.DataValueType.MEDIUM_TEXT,o.DataValueType.MAXSIZE_TEXT,o.DataValueType.LONG_TEXT,o.DataValueType.FLOAT1,o.DataValueType.FLOAT2,o.DataValueType.FLOAT3,o.DataValueType.FLOAT4,o.DataValueType.FLOAT8,o.DataValueType.PHONE_TEXT,o.DataValueType.WEB_TEXT,o.DataValueType.EMAIL_TEXT];class q{constructor(e,t,a){this._cellViewConfigCreatorFactory=e,this._rightsService=t,this._featureService=a}_getColumnName(e){return e.dataValueType===o.DataValueType.Lookup?`${e.path}Id`:e.path}_getColumnsAccessRights(e){const t=(0,E.uniq)(e.attributes.map(this._getColumnName));return this._featureService.getFeatureState(fe).pipe((0,g.switchMap)(r=>r?this._requestColumnsAccessRights(e.name,t):this._allowColumnsAccessRights(t)))}_allowColumnsAccessRights(e){const t={};return e.forEach(a=>t[a]=!0),(0,m.of)(t)}_requestColumnsAccessRights(e,t){return this._rightsService.getCanEditColumns({schemaName:e,columnNames:t})}_isReadonlyColumn(e,t){const a=this._getColumnName(t),r=!t.isSystem,n=t.attributeType===o.DataSchemaAttributeType.OwnAttribute,s=ye.includes(t.dataValueType);return!(e[a]&&n&&r&&s)}_generateColumnDefinition(e,t,a){const{dataSourceName:r,dataSchema:n,itemsAttributeName:s,viewModel:c,features:d,dataGridName:f}=e,y=t.name,{primaryAttributeName:K,primaryDisplayAttributeName:ce,name:Ge}=n??{},Le=K&&`${r}_${K}`,Oe={columnName:y,dataValueType:t.dataValueType,primaryDisplayAttributeName:ce},Me={column:{...a,id:(0,o.generateGuid)()},context:c,itemsAttributeName:s,features:d,primaryAttributeName:Le,primaryDisplayAttributeName:ce,columnName:y,dataGridName:f,dataGridSchemaName:Ge},$e=this._cellViewConfigCreatorFactory.create(Oe)?.getViewElementConfig(Me)??(0,m.of)(null);return(0,m.from)($e).pipe((0,g.map)(we=>({...a,cellView:we})))}processDataGridColumnDefinitions(e,t){const{dataSourceName:a,dataSchema:r}=e;return this._getColumnsAccessRights(r).pipe((0,g.switchMap)(n=>{const s=t.map(c=>{const d=r.attributes.find(f=>(0,h.removeSpecialSymbols)(`${a}_${f.name}`)===c.code);return d?(0,E.isUndefined)(c.readonly)?this._generateColumnDefinition(e,d,{...c,readonly:this._isReadonlyColumn(n,d)}):this._generateColumnDefinition(e,d,c):(0,m.of)(c)});return(0,m.forkJoin)(s)}))}getDataGridColumnDefinition(e,t,a){const{dataSchema:r,dataSourceName:n}=e;return this._getColumnsAccessRights(r).pipe((0,g.switchMap)(s=>{const c=`${n}_${t.name}`,d=(0,o.generateGuid)(),f={id:d,code:(0,h.removeSpecialSymbols)(c),caption:a||`#ResourceString(${d.split("-")[0]})#`,dataValueType:t.dataValueType,readonly:this._isReadonlyColumn(s,t)};return this._generateColumnDefinition(e,t,f)}))}static{this.\u0275fac=function(t){return new(t||q)(i.\u0275\u0275inject(ae),i.\u0275\u0275inject(re.RightsService),i.\u0275\u0275inject(re.FeatureService))}}static{this.\u0275prov=i.\u0275\u0275defineInjectable({token:q,factory:q.\u0275fac,providedIn:"root"})}}var ve=p(45447),Ve=p.n(ve);class ee extends P{constructor(e,t,a,r,n,s){super(e),this._maskService=t,this._metadataModifier=a,this._schemaPartService=r,this._entitySchemaRepository=n,this._dataGridActiveFolderDesignSettingsProvider=s}_getResourcesFromProfile(){var e=this;return(0,u.A)(function*(){const[,t]=yield e._schemaPartService.use("USER"),a=yield t.loadResources();return{strings:(0,E.cloneDeep)(a?.localizableStrings)}})()}_getResourcesFromActiveFolderSettings(e,t){var a=this;return(0,u.A)(function*(){const r=yield a._dataGridActiveFolderDesignSettingsProvider.get({viewConfig:e,viewModel:t,metadata:a.schemaService.schema});return{strings:(0,E.cloneDeep)(r?.resources?.localizableStrings??{})}})()}getResources(e,t){var a=this;return(0,u.A)(function*(){const r=yield a._getResourcesFromProfile(),n=yield a._getResourcesFromActiveFolderSettings(e,t);return Ve()(r,n)})()}getEntitySchemaNameByPath(e,t){const a=t.split("."),r=this._entitySchemaRepository.findEntitySchemaByPath(e,a);return Promise.resolve(r?.name)}setColumnCaptionResources(e,t,a){const r=this._metadataModifier.revert((0,E.cloneDeep)(e)),n=(0,h.extractResourcesKey)(r.caption);n&&(e.captionResources=(0,h.toLocalizableStringsArray)(t.strings,n))}processColumns(e,t,a){return this._maskService.showBodyMask(),super.processColumns(e,t,a)}onColumnPreparationFinished(){this._maskService.hideBodyMask()}static{this.\u0275fac=function(t){return new(t||ee)(i.\u0275\u0275inject(i.Injector),i.\u0275\u0275inject(o.MaskService),i.\u0275\u0275inject(U.MetadataModifierService),i.\u0275\u0275inject(x.SchemaPartsService),i.\u0275\u0275inject(h.EntitySchemaRepository),i.\u0275\u0275inject(D.DataGridActiveFolderDesignSettingsProvider))}}static{this.\u0275prov=i.\u0275\u0275defineInjectable({token:ee,factory:ee.\u0275fac})}}class te{constructor(e){this._columnSelectionService=e}_canSelectColumns(e){if(e===null)return(0,m.of)(!1);const t={type:"crt.CanDiscardUnsavedDataRequest",$context:e},a=o.HandlerChainService.instance.process(t);return(0,m.from)(a)}_getDataGridCollection(e,t){const a=e.get(T.VIEW_ELEMENT_CONFIG),r=(0,D.getViewModelItemsAttributeName)(a);return r?(0,m.from)(t[r]).pipe((0,g.map)(n=>n)):(0,m.of)(null)}selectColumns(e){return e.get(T.BINDING_CONTEXT).viewModel$.pipe((0,g.switchMap)(t=>this._getDataGridCollection(e,t)),(0,g.switchMap)(t=>this._canSelectColumns(t)),(0,g.switchMap)(t=>(0,m.iif)(()=>t,this._columnSelectionService.selectColumns(e),(0,m.of)([]))),(0,g.take)(1))}static{this.\u0275fac=function(t){return new(t||te)(i.\u0275\u0275inject(D.DataGridColumnSelectionService))}}static{this.\u0275prov=i.\u0275\u0275defineInjectable({token:te,factory:te.\u0275fac})}}const Fe=se.FactoryProvider.create({token:ae,mappings:[{predicate:({columnName:l,primaryDisplayAttributeName:e})=>!!l&&l===e,injectable:H},{predicate:({dataValueType:l})=>l===o.DataValueType.Lookup,injectable:X},{predicate:({dataValueType:l})=>l===o.DataValueType.Boolean,injectable:z},{predicate:({dataValueType:l})=>l===o.DataValueType.PHONE_TEXT,injectable:S},{predicate:({dataValueType:l})=>l===o.DataValueType.EMAIL_TEXT,injectable:A},{predicate:({dataValueType:l})=>l===o.DataValueType.RICH_TEXT,injectable:V},{predicate:({dataValueType:l})=>l===o.DataValueType.EMAIL_TEXT||l===o.DataValueType.WEB_TEXT,injectable:Y},{predicate:({dataValueType:l,columnName:e})=>l===o.DataValueType.Guid&&e.includes("DcmStageValue"),injectable:F}]}),be=se.FactoryProvider.create({token:pe,mappings:[{predicate:({dataValueType:l})=>h.DATE_TIME_DATA_VALUE_TYPES.includes(l),injectable:G},{predicate:({dataValueType:l})=>h.NUMERIC_DATA_VALUE_TYPES.includes(l),injectable:R},{predicate:({dataValueType:l})=>l===o.DataValueType.Lookup,injectable:N},{predicate:({dataValueType:l})=>l===o.DataValueType.Boolean,injectable:L},{predicate:({dataValueType:l})=>l===o.DataValueType.PHONE_TEXT,injectable:O},{predicate:({dataValueType:l})=>l===o.DataValueType.EMAIL_TEXT,injectable:M},{predicate:({dataValueType:l})=>l===o.DataValueType.WEB_TEXT,injectable:$},{predicate:({dataValueType:l,columnName:e})=>l===o.DataValueType.Guid&&e.includes("DcmStageValue"),injectable:w}],default:{injectable:b}}),Re=se.FactoryProvider.create({token:he,mappings:[{predicate:({columnName:l,primaryDisplayAttributeName:e})=>l&&l===e,injectable:I},{predicate:({columnName:l})=>l&&l==="Size",injectable:v}]});var J=p(5960);let le=class extends o.BaseRequest{constructor(){super(...arguments),this.type="crt.DataGridCancelItemsChangesRequest"}};le=(0,J.__decorate)([(0,o.CrtRequest)({type:"crt.DataGridCancelItemsChangesRequest"})],le);let ne=class extends o.BaseRequestHandler{constructor(e){super(),this._schemaService=e}_canCancelItemsChanges(e){var t=this;return(0,u.A)(function*(){const{$context:a,itemsAttributeName:r,changedItems:n}=e;if(!a||!r)return!1;if(n&&n.length>0)return!0;const c={type:"crt.CanDiscardUnsavedDataRequest",$context:yield a[r]};return yield t.handlerChain.process(c)})()}_cancelItemsChanges(e){var t=this;return(0,u.A)(function*(){const a={type:"crt.CancelRecordsChangesRequest",$context:e.$context,recordIds:e.changedItems,itemsAttributeName:e.itemsAttributeName};return yield t.handlerChain.process(a)})()}_getDataGridViewConfigs(e){return this._schemaService.getViewConfigInfoByFilter(t=>{const{type:a,items:r}=t;return a==="crt.DataGrid"&&r===`$${e}`}).map(t=>t.viewConfig)}_cleanupSelectionState(e,t){const a=this._getDataGridViewConfigs(e).map(r=>r?._selectionOptions?.attribute||(0,D.createDataGridSelectionStateAttributeName)(r)).map(r=>this.handlerChain.process({type:"crt.ChangeViewModelAttributeValueRequest",$context:t,attributeName:r,attributeValue:null}));return Promise.all(a)}handle(e){var t=this;return(0,u.A)(function*(){return e?(yield t._canCancelItemsChanges(e))?t._cancelItemsChanges(e):(yield t._cleanupSelectionState(e.itemsAttributeName,e.$context),!1):!1})()}};ne=(0,J.__decorate)([(0,o.CrtRequestHandler)({type:"crt.DataGridCancelItemsChangesHandler",requestType:"crt.DataGridCancelItemsChangesRequest"}),(0,J.__metadata)("design:paramtypes",[x.SchemaService])],ne);let ue=class extends o.BaseRequest{};ue=(0,J.__decorate)([(0,o.CrtRequest)({type:"crt.DataGridRowDoubleClickRequest"})],ue);let ie=class extends o.BaseRequestHandler{_isClickByNewRecord(e){return(0,u.A)(function*(){const{itemsAttributeName:t,rowId:a}=e;return!t||!a?!1:(yield(yield e.$context[t])?.findByPrimaryAttribute(a))?.getPrimaryModelMode()===h.ModelMode.Create})()}_createUpdateRecordRequest(e){return{type:"crt.UpdateRecordRequest",$context:e.$context,recordId:e.rowId,itemsAttributeName:e.itemsAttributeName}}handle(e){var t=this;return(0,u.A)(function*(){return(yield t._isClickByNewRecord(e))?Promise.resolve():t.handlerChain.process(t._createUpdateRecordRequest(e))})()}};ie=(0,J.__decorate)([(0,o.CrtRequestHandler)({requestType:"crt.DataGridRowDoubleClickRequest",type:"crt.DataGridRowDoubleClickHandler"})],ie);var Ce=p(40297),Ne=p(74072);let oe=class de{static{this.\u0275fac=function(t){return new(t||de)}}static{this.\u0275mod=i.\u0275\u0275defineNgModule({type:de})}static{this.\u0275inj=i.\u0275\u0275defineInjector({imports:[Ce.CommonModule]})}};oe=(0,J.__decorate)([(0,o.CrtModule)({requestHandlers:[ne,ie],converters:[Ne.EntityStageDataTableSliderConverter]})],oe),function(){(typeof ngJitMode>"u"||ngJitMode)&&i.\u0275\u0275setNgModuleScope(oe,{imports:[Ce.CommonModule]})}()}}]);
