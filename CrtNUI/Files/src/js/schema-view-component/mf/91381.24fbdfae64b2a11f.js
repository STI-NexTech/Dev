(self.webpackChunkapp_studio_enterprise_schema_view=self.webpackChunkapp_studio_enterprise_schema_view||[]).push([[91381],{91381:(je,re,u)=>{u.r(re),u.d(re,{CopilotChatService:()=>g,CopilotModule:()=>T,CopilotService:()=>I});var r=u(5960),i=u(38495),b=u(96590),j=u(85638),ae=u(72214),N=u(95868),a=u(73308),l=u(62278);let H=class{constructor(e){this._intentSchemaManager=e}convert(e,t,s){var o=this;return(0,a.A)(function*(){const n=e.map(function(){var _=(0,a.A)(function*(C){return yield C[s]});return function(C){return _.apply(this,arguments)}}()),p=yield Promise.all(n);return(0,l.lastValueFrom)(o._intentSchemaManager.generateActionCode(p))})()}};H=(0,r.__decorate)([(0,i.CrtConverter)({type:"crt.GenerateCopilotActionCode"}),(0,r.__metadata)("design:paramtypes",[N.CopilotIntentManagerService])],H);var x=u(79772),Ie=u(20822),D=u(10710),h=u(21018),A=u(28399);let ce=class extends i.BaseRequest{};ce=(0,r.__decorate)([(0,i.CrtRequest)({type:"crt.CopilotSayRequest"})],ce);var y;(function(c){c.Assistant="assistant",c.User="user"})(y||(y={}));let le=class extends i.BaseRequest{};le=(0,r.__decorate)([(0,i.CrtRequest)({type:"crt.CopilotRestartSessionRequest"})],le);class de{static get photo(){return"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGcgaWQ9Ikljb24gfCBBSSBDb3BpbG90IC0gMTZ4MTYgfCBoZWF2eSI+CjxwYXRoIGlkPSJVbmlvbiIgZmlsbC1ydWxlPSJldmVub2RkIiBjbGlwLXJ1bGU9ImV2ZW5vZGQiIGQ9Ik0xIDhDMSA3LjQxNTk2IDEuMDcxNTMgNi44NDg2MiAxLjIwNjMgNi4zMDYyN0wyLjY0ODM2IDcuMTEwNUMyLjYwMDYyIDcuMzk5OTIgMi41NzU3OCA3LjY5NzA2IDIuNTc1NzggOEMyLjU3NTc4IDEwLjk5NTcgNS4wMDQyOSAxMy40MjQyIDggMTMuNDI0MkM5LjY2MTgyIDEzLjQyNDIgMTEuMTQ5MSAxMi42NzY5IDEyLjE0NDEgMTEuNUgxNC4wNjM1QzEyLjg1MzIgMTMuNTkyMyAxMC41OTEgMTUgOCAxNUM0LjEzNDAxIDE1IDEgMTEuODY2IDEgOFpNOCAyLjU3NTc4QzkuNjYxODIgMi41NzU3OCAxMS4xNDkxIDMuMzIzMSAxMi4xNDQxIDQuNUgxNC4wNjM1QzEyLjg1MzIgMi40MDc3IDEwLjU5MSAxIDggMUM2LjU1MDc3IDEgNS4yMDQ0IDEuNDQwNDEgNC4wODc0MyAyLjE5NDY4TDYuMzMzNzggMi44MzY1QzYuODU4NzcgMi42NjcyMiA3LjQxODcgMi41NzU3OCA4IDIuNTc1NzhaTTcuMTI1IDExLjA2MjVMMTUgOEwxIDIuNzVMOC40Mzc1IDhMNy4xMjUgMTEuMDYyNVoiIGZpbGw9IiMwRDJFNEUiLz4KPC9nPgo8L3N2Zz4K"}static get title(){return"Copilot"}static get contact(){return{photo:this.photo,name:this.title}}}let pe=class extends i.BaseRequest{};pe=(0,r.__decorate)([(0,i.CrtRequest)({type:"crt.CopilotExecuteIntentRequest"})],pe);let ue=class extends i.BaseRequest{};ue=(0,r.__decorate)([(0,i.CrtRequest)({type:"crt.CopilotGetAvailableIntentsRequest"})],ue);var _e;(function(c){c.ExecutedSuccessfully="ExecutedSuccessfully",c.CantGenerateGoodResponse="CantGenerateGoodResponse",c.FailedToExecute="FailedToExecute",c.ResponseParsingFailed="ResponseParsingFailed",c.IntentNotFound="IntentNotFound",c.InactiveIntent="InactiveIntent",c.WrongIntentMode="WrongIntentMode",c.InsufficientPermissions="InsufficientPermissions"})(_e||(_e={}));var d=u(59131);class v{constructor(e,t){this._featureValues=e,this._translateService=t}_getAuthorByRole(e,t){return e===y.Assistant?de.contact:null}_getIsBotMessage(e){return e===y.Assistant}_getMessageDirection(e){return e===y.User?D.MessageDirection.Outcoming:D.MessageDirection.Incoming}_addCopilotMessageActions(e){e.actions=[{caption:this._translateService.instant("Conversation.Copilot.Action.Replace"),type:h.ChatMessageActionType.Replace},{caption:this._translateService.instant("Conversation.Copilot.Action.InsertAbove"),type:h.ChatMessageActionType.InsertAbove},{caption:this._translateService.instant("Conversation.Copilot.Action.InsertBelow"),type:h.ChatMessageActionType.InsertBelow}]}convertMessages(e,t){return e.filter(s=>(s.role===y.Assistant||s.role===y.User)&&!(0,A.isEmpty)(s.content)).map(s=>{const o=s.createdOnTicks*1e-4,n={text:s.content,type:Ie.ChatMessageTypeEnum.Text,date:new Date(o),isBotMessage:!0,id:s.id};return n.author=this._getAuthorByRole(s.role,t),n.isBotMessage=this._getIsBotMessage(s.role),n.direction=this._getMessageDirection(s.role),this._featureValues.SelectionRewriteActions&&n.direction===D.MessageDirection.Incoming&&n.isBotMessage&&this._addCopilotMessageActions(n),n})}static{this.\u0275fac=function(t){return new(t||v)(d.\u0275\u0275inject(h.FEATURE_VALUES),d.\u0275\u0275inject(x.TranslateService))}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:v,factory:v.\u0275fac})}}let he=class extends i.BaseRequest{};he=(0,r.__decorate)([(0,i.CrtRequest)({type:"crt.GenerateCopilotActionCodeValueRequest"})],he);let w=class extends i.BaseRequestHandler{constructor(e){super(),this.injector=e,this._cacheAttributeName="_ActionCodes_Cache",this._initialCodeValueAttributeName="_InitialCodeValue",this._intentManager=this.injector.get(N.CopilotIntentManagerService)}_getActionCodes(e,t){var s=this;return(0,a.A)(function*(){const o=yield e[s._cacheAttributeName];if(o?.length>0)return(0,l.of)(o);const n=yield e[t];return s._intentManager.getIntent(n?.value).pipe((0,l.map)(p=>p.Actions.map(_=>_.Code)),(0,l.tap)(p=>e[s._cacheAttributeName]=p))})()}handle(e){var t=this;return(0,a.A)(function*(){const s=e.$context;if(s.PrimaryModelMode!==h.ModelMode.Create){yield t.next?.handle(e);return}let o=yield s[t._initialCodeValueAttributeName];o||(o=yield s[e.codeAttributeName],s[t._initialCodeValueAttributeName]=o);const n=yield s[e.valueAttributeName];if(!n){s[e.codeAttributeName]=o;return}const p=(yield t._getActionCodes(s,e.intentAttributeName)).pipe((0,l.switchMap)(_=>t._intentManager.generateActionCode(_,n)));s[e.codeAttributeName]=(yield(0,l.lastValueFrom)(p))??(yield s[t._initialCodeValueAttributeName]),yield t.next?.handle(e)})()}};w=(0,r.__decorate)([(0,i.CrtRequestHandler)({type:"crt.GenerateCopilotActionCodeValueHandler",requestType:"crt.GenerateCopilotActionCodeValueRequest"}),(0,r.__metadata)("design:paramtypes",[d.Injector])],w);const m={process:"ProcessSchemaUId",params:"PDS_Params"},U="CopilotChatInitMessagesSubscriptions",Ce="NavigationStateIsLoading",L="CurrentPageSchemaName",me="CopilotIntents",ge="CopilotIntentPageQuickLinks",fe="CopilotQuickActions";let V=class extends i.BaseRequestHandler{constructor(e){super(),this._customEventService=e}_getModelInitConfig(e){return(0,a.A)(function*(){const t=e.modelInitConfigs,s=yield e.getPrimaryModelName();return t?.find(o=>o.name===s)})()}handle(e){var t=this;return(0,a.A)(function*(){const s=e.$context;s[m.process]=null;const o=yield t.next?.handle(e);if((yield t._getModelInitConfig(s))?.action===i.ModelInPageAction.Add)return o;const _=yield s.ProcessDesignerInstanceId;return yield new Promise(C=>{const O={designerInstanceId:_,callback:C};t._customEventService.createOutboundChannel("cancelProcessSchemaChanges").next(O)}),o})()}};V=(0,r.__decorate)([(0,i.CrtRequestHandler)({requestType:"crt.CancelRecordChangesRequest",type:"crt.CopilotProcessActionsCancelRecordHandler",scopes:["CopilotProcessActions_FormPage"]}),(0,r.__metadata)("design:paramtypes",[b.CustomEventService])],V);let $=class extends i.BaseRequestHandler{constructor(e,t){super(),this._customEventService=e,this._translateService=t}_performDesignerSave(e,t){var s=this;return(0,a.A)(function*(){const o=yield e.ProcessDesignerInstanceId;return new Promise(n=>{const p={designerInstanceId:o,needSaveNewVersion:t,saveCallback:n};s._customEventService.createOutboundChannel("saveProcessSchema").next(p)})})()}_showDesignerValidationErrorNotification(e){var t=this;return(0,a.A)(function*(){const o=yield(0,l.lastValueFrom)(t._translateService.get("Dialog.ProcessSchemaSavedWithValidationError")),n={type:"crt.NotificationRequest",$context:e,message:o,translate:!1};yield t.handlerChain.process(n)})()}handle(e){var t=this;return(0,a.A)(function*(){const s=e.$context,o=e.config,n=o?o.needSaveNewVersion:!1;if(!(yield s.isValid()))return yield t.next?.handle(e);const _=yield t._performDesignerSave(s,n);return _.isCanceled?!1:(_.isValid||(yield t._showDesignerValidationErrorNotification(s)),yield t.next?.handle(e))})()}};$=(0,r.__decorate)([(0,i.CrtRequestHandler)({requestType:"crt.SaveRecordRequest",type:"crt.CopilotProcessActionsPageSaveHandler",scopes:["CopilotProcessActions_FormPage"]}),(0,r.__metadata)("design:paramtypes",[b.CustomEventService,x.TranslateService])],$);function Ae(c){return B.apply(this,arguments)}function B(){return B=(0,a.A)(function*(c){const e="ProcessDesignerInstanceId";let t=yield c[e];t||(t=(0,i.generateGuid)(),c[e]=t)}),B.apply(this,arguments)}let F=class extends i.BaseRequestHandler{_subscribeParamsLoaded(e){const t=new l.Subscription;t.add(e.events$.pipe((0,l.filter)(({type:s})=>s==="finish-load-model-attributes"),(0,l.filter)(({payload:s})=>s[m.params]),(0,l.switchMap)(()=>e[m.params]),(0,l.filter)(s=>!!s)).subscribe({next:function(){var s=(0,a.A)(function*(o){let n;try{n=JSON.parse(o).processSchemaUId}catch(C){console.error(`params = ${o}
${C?.message}`)}const p={silent:!0},_={[m.process]:n};e.setValue(_,p),yield Ae(e)});return function(n){return s.apply(this,arguments)}}(),complete:()=>{t.unsubscribe()}}))}handle(e){var t=this;return(0,a.A)(function*(){yield t.next?.handle(e),t._subscribeParamsLoaded(e.$context)})()}};F=(0,r.__decorate)([(0,i.CrtRequestHandler)({type:"crt.CopilotProcessActionsPageInitHandler",requestType:"crt.HandleViewModelInitRequest",scopes:["CopilotProcessActions_FormPage"]})],F);var R=u(10850);let G=class extends i.BaseRequestHandler{constructor(){super(...arguments),this._statusFlags=["ProcessSchemaIsChanged","HasUnsavedData",R.IS_CHANGED_SYSTEM_ATTRIBUTE_NAME,m.process]}_handleProcessChange(e){if(e.attributeName===m.process&&!e.silent){const t={processSchemaUId:e.value};e.$context[m.params]=JSON.stringify(t)}}_handleCreateModel(e){return(0,a.A)(function*(){e.attributeName===R.PRIMARY_MODEL_MODE_SYSTEM_ATTRIBUTE_NAME&&e.value===h.ModelMode.Create&&(e.$context[m.process]=i.EMPTY_GUID,yield Ae(e.$context))})()}handle(e){var t=this;return(0,a.A)(function*(){if(t._handleProcessChange(e),yield t._handleCreateModel(e),e.attributeName==="ProcessSchemaIsLoaded"&&e.value){const s=yield e.$context.getPrimaryModelName();e.$context.getModelByName(s).setLoadedState()}else if(t._statusFlags.includes(e.attributeName)){const s=yield e.$context[m.process],o=yield e.$context.ProcessSchemaIsLoaded,n=yield e.$context.ProcessSchemaIsChanged,p=yield e.$context.HasUnsavedData,_=yield e.$context.IsChanged;e.$context.ProcessActionHasUnsavedData=o&&s!==i.EMPTY_GUID&&(p||_||n)}return t.next?.handle(e)})()}};G=(0,r.__decorate)([(0,i.CrtRequestHandler)({type:"crt.CopilotProcessActionsPageAttributeChangeHandler",requestType:"crt.HandleViewModelAttributeChangeRequest",scopes:["CopilotProcessActions_FormPage"]})],G);var Re=u(23958),k=u(63721),ye=u(22438),P=u(36486);const Me="CopilotMsgChannelSender",be="CopilotChatPart";class g{constructor(e,t,s,o){this._httpClient=e,this._messageChannelService=t,this._contextSchemaService=s,this._featureValues=o,this._apiUrl="/rest/CopilotService",this._copilotSession=null;const n=this._featureValues??{};this._isNeedToAddConsoleLog=!!n.ShowSystemMessagesFromCopilot}getInitialMessages$(){return this._loadInitialMessages()}copilotMessageEvent$(){return this._messageChannelService.messageEvent$.pipe((0,l.filter)(e=>e.header.sender===Me&&e.header.bodyTypeName===be),(0,l.map)(e=>e.body.messages),(0,l.tap)(e=>{this._isNeedToAddConsoleLog&&(console.group("Copilot"),console.log(e),console.groupEnd())}))}_loadInitialMessages(){return this._getActiveCopilotSessions().pipe((0,l.mergeMap)(e=>this._handleActiveCopilotSessions(e).pipe((0,P.catchError)(t=>(console.error(t),(0,l.of)([]))))))}_handleActiveCopilotSessions(e){return e.length>0?(this._copilotSession=e[0],this._getCopilotSessionMessages(this._copilotSession.id)):(0,l.throwError)(()=>new Error("No active copilot sessions found"))}_getActiveCopilotSessions(){return this._httpClient.post(`${this._apiUrl}/GetActiveCopilotSessions`,{}).pipe((0,l.map)(e=>e.copilotSessions))}_getCopilotSessionMessages(e){return this._httpClient.post(`${this._apiUrl}/GetCopilotSessionMessage`,{copilotSessionId:e}).pipe((0,l.map)(t=>t.copilotMessages))}_sendUserMessage(e){return(0,l.from)(this._contextSchemaService.getContext()).pipe((0,l.switchMap)(t=>this._httpClient.post(`${this._apiUrl}/SendUserMessage`,{content:e,copilotContext:{parts:t||[]},copilotSessionId:this._copilotSession?.id})),(0,l.map)(t=>t?.copilotChatPart))}_closeCopilotSession(){return this._httpClient.post(`${this._apiUrl}/CloseSession`,{copilotSessionId:this._copilotSession?.id}).pipe((0,P.catchError)(e=>(0,l.throwError)(()=>new Error(`Server return status: ${e.status}`))))}sayWithResponse(e){var t=this;return(0,a.A)(function*(){const s=yield(0,l.firstValueFrom)(t._sendUserMessage(e));return s&&(0,A.isEmpty)(s.errorCode)&&(0,A.isEmpty)(s.errorMessage)&&(t._copilotSession=s.copilotSession),s})()}closeSession(){var e=this;return(0,a.A)(function*(){if(!e._copilotSession?.id)return Promise.reject("No active session");try{yield(0,l.firstValueFrom)(e._closeCopilotSession()),e._copilotSession=null}catch(t){return Promise.reject(`Server return status: ${t.status}`)}})()}static{this.\u0275fac=function(t){return new(t||g)(d.\u0275\u0275inject(k.HttpClient),d.\u0275\u0275inject(h.MessageChannelService),d.\u0275\u0275inject(ye.ContextSchemaService),d.\u0275\u0275inject(h.FEATURE_VALUES,8))}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:g,factory:g.\u0275fac,providedIn:"root"})}}class I{constructor(e){this._httpClient=e,this._executeIntentUrl="/rest/CopilotService/ExecuteIntent",this._getAvailableIntentsUrl="/rest/CopilotService/GetAvailableIntents"}_executeIntent(e,t,s){const o=s?Object.entries(s).map(([p,_])=>({Key:p,Value:_})):[],n={intentName:e,additionalPromptText:t,parameters:o};return this._httpClient.post(this._executeIntentUrl,n).pipe((0,P.catchError)(p=>(0,l.throwError)(()=>new Error(`Server return status: ${p.status}`))))}_getAvailableIntents(e,t){const s={names:e},o=this._getAvailableIntentsUrl+`/?mode=${t}`;return this._httpClient.post(o,s).pipe((0,P.catchError)(n=>(0,l.throwError)(()=>new Error(`Server return status: ${n.status}`))))}executeIntent(e,t,s){var o=this;return(0,a.A)(function*(){try{return yield(0,l.firstValueFrom)(o._executeIntent(e,t,s))}catch(n){const p=n.status?`Server return status: ${n.status}`:`${n}`;return Promise.reject(p)}})()}getAvailableIntents(e,t){var s=this;return(0,a.A)(function*(){t||(t="API");try{return yield(0,l.firstValueFrom)(s._getAvailableIntents(e,t))}catch(o){const n=o.status?`Server return status: ${o.status}`:`${o}`;return Promise.reject(n)}})()}static{this.\u0275fac=function(t){return new(t||I)(d.\u0275\u0275inject(k.HttpClient))}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:I,factory:I.\u0275fac,providedIn:"root"})}}let J=class extends i.BaseRequestHandler{constructor(e,t,s,o){super(),this._copilotChatService=e,this._crtRouter=t,this._userInfo=s,this._injector=o,this.userConsentService=o.get(j.UserConsentService),this._copilotToChatConvertor=o.get(v)}_getConvertedMessages(e){return this._copilotToChatConvertor.convertMessages(e,{id:this._userInfo.contactId,name:this._userInfo.contactName,photoId:this._userInfo.photoId})}_initUserConsentData(e){this.userConsentService.getConsent("CopilotLegalNotice").subscribe(t=>{t&&(e.CopilotDisclaimer=t.consentText,this.userConsentService.getUserConsent(t.id).subscribe(s=>{e.IsCopilotChatVisible=s!==null,e.IsCopilotDisclaimerVisible=s===null}))})}_initWatchNavigation(e){var t=this;return(0,a.A)(function*(){const s=t._crtRouter.navigateStart$.pipe((0,l.tap)(()=>e[Ce]=!0)).subscribe(),o=t._crtRouter.navigateEnd$.pipe((0,l.tap)((0,a.A)(function*(){e[Ce]=!1;const n=yield(0,l.firstValueFrom)(t._crtRouter.crtRoute$);e[L]=n?.state?.schemaName}))).subscribe();yield t._addToSubscriptions(e,[s,o])})()}_addToSubscriptions(e,t){return(0,a.A)(function*(){const s=(yield e[U])??[];e[U]=s,s.push(...t)})()}handle(e){var t=this;return(0,a.A)(function*(){yield t.next?.handle(e);const s=e.$context;e.$context.ChatMessages=t._getConvertedMessages(yield(0,l.lastValueFrom)(t._copilotChatService.getInitialMessages$()));const o=t._copilotChatService.copilotMessageEvent$().subscribe(n=>{e.$context.ChatMessages=t._getConvertedMessages(n)});yield t._addToSubscriptions(s,[o]),e.$context.CopilotContact=de.contact,t._initUserConsentData(e.$context),yield t._initWatchNavigation(s)})()}};J=(0,r.__decorate)([(0,i.CrtRequestHandler)({type:"crt.CopilotChatInitHandler",requestType:"crt.HandleViewModelInitRequest",scopes:["CopilotPanel"]}),(0,r.__metadata)("design:paramtypes",[g,Re.CrtRouter,h.UserInfo,d.Injector])],J);let Se=class extends i.BaseRequestHandler{constructor(){super()}handle(e){var t=this;return(0,a.A)(function*(){const o=yield e.$context[U];if(Array.isArray(o))for(const n of o)n?.unsubscribe();yield t.next?.handle(e)})()}};Se=(0,r.__decorate)([(0,i.CrtRequestHandler)({type:"crt.CopilotChatDestroyHandler",requestType:"crt.HandleViewModelDestroyRequest",scopes:["CopilotPanel"]}),(0,r.__metadata)("design:paramtypes",[])],Se);let z=class extends i.BaseRequestHandler{constructor(e){super(),this._userConsentService=e.get(j.UserConsentService)}handle(e){var t=this;return(0,a.A)(function*(){t._userConsentService.giveUserConsent(e.consentCode).subscribe(()=>{e.$context.IsCopilotChatVisible=!0,e.$context.IsCopilotDisclaimerVisible=!1}),yield t.next?.handle(e)})()}};z=(0,r.__decorate)([(0,i.CrtRequestHandler)({type:"crt.CopilotDisclaimerAcceptHandler",requestType:"crt.CopilotDisclaimerAcceptRequest",scopes:["CopilotPanel"]}),(0,r.__metadata)("design:paramtypes",[d.Injector])],z);let Q=class extends i.BaseRequestHandler{constructor(){super(...arguments),this._watchAttributes=[L,me,ge]}_actualizeCopilotQuickActions(e){var t=this;return(0,a.A)(function*(){const s=yield e[fe],o=(yield e[me])??[],n=yield e[ge];if(!Array.isArray(o)||o.length===0||!Array.isArray(n)||n.length===0)return;yield s.clear();const p=yield e[L],C=(yield Promise.all(n.map(function(){var S=(0,a.A)(function*(E){return{pageName:yield E.PageName,intentCode:yield E.IntentCode}});return function(E){return S.apply(this,arguments)}}()))).filter(S=>t._isPatternMatch(S.pageName,p)).map(S=>S.intentCode),O=[];for(const S of o){const E=yield S.Code;t._hasMatchingPattern(C,E)&&O.push(S)}yield s.reload(O)})()}_hasMatchingPattern(e,t){return e.some(s=>this._isPatternMatch(s,t))}_isPatternMatch(e,t){t=`${t}`.trim().toLowerCase(),e=`${e}`.trim().toLowerCase();const[s]=e.split("*").filter(Boolean);return e==="*"?!0:e.startsWith("*")?t.endsWith(s):e.endsWith("*")?t.startsWith(s):e===t}handle(e){var t=this;return(0,a.A)(function*(){const s=e.$context;if(t._watchAttributes.includes(e.attributeName))return yield t._actualizeCopilotQuickActions(s),t.next?.handle(e)})()}};Q=(0,r.__decorate)([(0,i.CrtRequestHandler)({type:"crt.CopilotActualizeIntentQuickLinksHandler",requestType:"crt.HandleViewModelAttributeChangeRequest",scopes:["CopilotPanel"]})],Q);var Ne=u(59564);class f{static{this.errorCodeGroups={AuthorizationError:["MissingApiKey","InvalidApiKey","Unauthorized","UnauthorizedClient","InvalidScope","InvalidGrantType"],FormatError:["InvalidRequest","InvalidJson","NoEntities"],LimitError:["RateLimitReached","InsufficientQuota","QuotaExceeded","InternalQuotaExceeded","LimitExceeded"],ServiceAvailabilityError:["ServiceUnavailable","ServerNotAvailable","EngineOverloaded","ServerError","RequestTimeout","NetworkError"],ExecutionError:["ActionExecutionFailed","InvalidResponse"],ConfigurationError:["InvalidUri","ModelNotFound","ModelError","IncorrectConfiguration"],UnknownError:["Unknown","UnknownError"]}}static{this.errorCodeToGroup=f._populateErrorCodeToGroupMap()}static getErrorMessageKey(e){return`MessageEditor.ErrorCode.${f.errorCodeToGroup[e]||"UnknownError"}`}static _populateErrorCodeToGroupMap(){const e={};return Object.keys(f.errorCodeGroups).forEach(t=>{for(const s of f.errorCodeGroups[t])e[s]=t}),e}}class M extends g{constructor(e,t,s,o,n,p,_){super(e,t,s,o),this._copilotChatService=n,this._notifyService=p,this._translateService=_}_getCurrentUserTime(){return new Date().getTime()*1e4+621355968e9}_sendErrorMessageToChat(e,t){var s=this;return(0,a.A)(function*(){if(!e)return;const o=f.getErrorMessageKey(t??""),n={id:(0,i.generateGuid)(),createdOnTicks:s._getCurrentUserTime(),content:s._translateService.instant(o),role:y.Assistant,isSaved:!0};e?.messages?.push(n)})()}_notifyUser(e){var t=this;return(0,a.A)(function*(){const s=f.getErrorMessageKey(e??"");yield t._notifyService.error({message:s})})()}sayWithResponse(e){var t=this;return(0,a.A)(function*(){let s;try{s=yield t._copilotChatService.sayWithResponse(e);const o=s?.errorCode;return o&&(yield t._sendErrorMessageToChat(s,o),yield t._notifyUser(o)),s}catch(o){yield t._sendErrorMessageToChat(s),yield t._notifyUser(),console.error(o)}})()}static{this.\u0275fac=function(t){return new(t||M)(d.\u0275\u0275inject(k.HttpClient),d.\u0275\u0275inject(h.MessageChannelService),d.\u0275\u0275inject(ye.ContextSchemaService),d.\u0275\u0275inject(h.FEATURE_VALUES,8),d.\u0275\u0275inject(g),d.\u0275\u0275inject(Ne.NotifyService),d.\u0275\u0275inject(x.TranslateService))}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:M,factory:M.\u0275fac,providedIn:"root"})}}class ve extends i.BaseRequestHandler{constructor(e){super(),this._copilotChatService=e.get(M)}_setTypingVisible(e,t){e.$context.IsTyping=t}handle(e){var t=this;return(0,a.A)(function*(){const s=e;t._setTypingVisible(s,!0);const o=yield t._copilotChatService.sayWithResponse(s.prompt);return t._setTypingVisible(s,!1),o})()}}let q=class extends ve{constructor(e){super(e),this._userInfo=e.get(h.UserInfo),this._copilotToChatConvertor=e.get(v)}_getConvertedMessages(e){return this._copilotToChatConvertor.convertMessages(e,{id:this._userInfo.contactId,name:this._userInfo.contactName,photoId:this._userInfo.photoId})}_addMessageToConversation(e,t,s){e.$context[s]=this._getConvertedMessages(t)}handle(e){var t=()=>super.handle,s=this;return(0,a.A)(function*(){const o=e.attributesMapping,n=o?.chatInput;if(!(0,A.isEmpty)(n)){const p=yield e.$context[n];e.$context[n]="";const _=yield t().call(s,Object.assign(e,{prompt:p}));if(!_)e.$context[n]=p;else if(_?.messages.length){const C=o?.chatMessages;(0,A.isEmpty)(C)||s._addMessageToConversation(e,_.messages,C)}}yield s.next?.handle(e)})()}};q=(0,r.__decorate)([(0,i.CrtRequestHandler)({type:"crt.CopilotMessageEditorSendHandler",requestType:"crt.MessageEditorSendRequest",scopes:["CopilotPanel"]}),(0,r.__metadata)("design:paramtypes",[d.Injector])],q);var Ee=u(98005);let W=class extends i.BaseRequestHandler{constructor(e){super(),this._copilotChatService=e.get(g),this._copilotToEditorCommunicationService=e.get(h.CopilotToEditorCommunicationService)}handle(e){var t=this;return(0,a.A)(function*(){yield t._copilotChatService.closeSession();const s=e.chatMessagesAttributeName,o=e.conversationEventAttributeName;!(0,A.isEmpty)(s)&&!(0,A.isEmpty)(o)&&(e.$context[s]=[],e.$context[o]=[{name:Ee.CONVERSATION_RESET_EVENT}]),t._copilotToEditorCommunicationService.notify({editorAction:h.EditorActionType.RemoveHighlighting}),yield t.next?.handle(e)})()}};W=(0,r.__decorate)([(0,i.CrtRequestHandler)({type:"crt.CopilotRestartSessionHandler",requestType:"crt.CopilotRestartSessionRequest",scopes:["CopilotPanel"]}),(0,r.__metadata)("design:paramtypes",[d.Injector])],W);let Y=class extends i.BaseRequestHandler{constructor(e){super(),this.injector=e,this._intentManager=this.injector.get(N.CopilotIntentManagerService)}_getModelInitConfig(e){return(0,a.A)(function*(){const t=e.modelInitConfigs,s=yield e.getPrimaryModelName();return t?.find(o=>o.name===s)})()}_getIntent(e,t){var s=this;return(0,a.A)(function*(){let o;const p=(yield e.getPrimaryDataSchema())?.name;return p==="CopilotIntent"?o=yield(0,l.firstValueFrom)(s._intentManager.getIntent(t)):p==="CopilotAction"&&(o=yield(0,l.firstValueFrom)(s._intentManager.getIntentByActionUId(t))),o})()}_disableCodeField(e){const t=e.getAttributeNameByViewItemName("Code");e.disableAttributeValidator(t,"CodePrefixValidator"),e.setAttributePropertyValue(t,"readonly",!0)}handle(e){var t=this;return(0,a.A)(function*(){yield t.next?.handle(e);const s=e.$context,o=yield t._getModelInitConfig(s);if(!(o?.action===i.ModelInPageAction.Edit))return;(yield t._getIntent(s,o?.recordId))?.ExtendParent&&t._disableCodeField(s)})()}};Y=(0,r.__decorate)([(0,i.CrtRequestHandler)({type:"crt.CopilotPageDisableCodeFieldHandler",requestType:"crt.HandleViewModelInitRequest",scopes:["CopilotIntents_FormPage","CopilotProcessActions_FormPage"]}),(0,r.__metadata)("design:paramtypes",[d.Injector])],Y);let K=class extends ve{constructor(e){super(e)}handle(e){var t=()=>super.handle,s=this;return(0,a.A)(function*(){yield s.handlerChain.process({type:"crt.OpenSidebarRequest",sidebarCode:"Copilot",$context:e.$context}),yield t().call(s,e),yield s.next?.handle(e)})()}};K=(0,r.__decorate)([(0,i.CrtRequestHandler)({type:"crt.CopilotActionRequestHandler",requestType:"crt.CopilotActionRequest"}),(0,r.__metadata)("design:paramtypes",[d.Injector])],K);var xe=u(68198);let Z=class extends i.BaseRequestHandler{constructor(e){super(),this._broadcastChannelFactory=e,this._init()}_init(){this._workspaceReloadBroadcastService=this._broadcastChannelFactory.createInstance(xe.WORKSPACE_EXPLORER_RELOAD_CHANNEL_NAME)}handle(e){var t=this;return(0,a.A)(function*(){const s=yield t.next?.handle(e);return t._workspaceReloadBroadcastService.publish(),s})()}};Z=(0,r.__decorate)([(0,i.CrtRequestHandler)({type:"crt.CopilotIntentSaveHandler",requestType:"crt.SaveRecordRequest",scopes:["CopilotIntents_FormPage"]}),(0,r.__metadata)("design:paramtypes",[b.BroadcastChannelFactory])],Z);let X=class extends i.BaseRequestHandler{constructor(e){super(),this._copilotService=e.get(I)}handle(e){var t=this;return(0,a.A)(function*(){const s=yield t._copilotService.executeIntent(e.intentName,e.additionalPromptText,e.parameters);return yield t.next?.handle(e),s})()}};X=(0,r.__decorate)([(0,i.CrtRequestHandler)({type:"crt.CopilotExecuteIntentHandler",requestType:"crt.CopilotExecuteIntentRequest"}),(0,r.__metadata)("design:paramtypes",[d.Injector])],X);let ee=class extends i.BaseRequestHandler{constructor(){super(...arguments),this._apiMode=R.INTENT_MODES_REFERENCE_MAP.get(R.INTENT_MODES.Api)}handle(e){var t=this;return(0,a.A)(function*(){if(e.attributeName==="PDS_Mode"){const s=e.value?e.value:yield e.$context.PDS_Mode;e.$context.IsApiMode=s?s.value===t._apiMode:!1}return t.next?.handle(e)})()}};ee=(0,r.__decorate)([(0,i.CrtRequestHandler)({type:"crt.CopilotIntentModeChangeHandler",requestType:"crt.HandleViewModelAttributeChangeRequest",scopes:["CopilotIntents_FormPage"]})],ee);var Pe=u(42946);let te=class extends i.BaseRequestHandler{constructor(e){super(),this._copilotPanelCode="Copilot",this._sidebarStateService=e.get(Pe.SidebarStateService),this._copilotChatService=e.get(M),this._translateService=e.get(x.TranslateService),this._copilotToEditorCommunicationService=e.get(h.CopilotToEditorCommunicationService)}_getPrompt(e,t){return["Friendly","Formal","Shorten","Extend","Rephrase","AskCopilot"].includes(t)?`${this._translateService.instant(`Copilot.RewriteActionsPrompt.${t}`)}: ${e}`:e}handle(e){var t=this;return(0,a.A)(function*(){const s=yield e.$context[e.selectionAttributeName];if(!(0,A.isEmpty)(s)){t._copilotToEditorCommunicationService.notify({editorAction:h.EditorActionType.SetHighlighting,selection:s});const o=t._getPrompt(s,e.rewriteAction);yield t._sidebarStateService.openRootSidebar(t._copilotPanelCode),yield t._copilotChatService.sayWithResponse(o)}yield t.next?.handle(e)})()}};te=(0,r.__decorate)([(0,i.CrtRequestHandler)({type:"crt.CopilotRewriteTextHandler",requestType:"crt.SelectionActionRequest",scopes:[R.Scopes.AllCards,"BasePageFreedomTemplate","BaseSidebarTemplate",R.Scopes.AllSections]}),(0,r.__metadata)("design:paramtypes",[d.Injector])],te);let se=class extends i.BaseRequestHandler{constructor(e){super(),this._copilotService=e.get(I)}_isObjectResponse(e){return!!e&&e===Object(e)&&!Array.isArray(e)}handle(e){var t=this;return(0,a.A)(function*(){const s=yield t._copilotService.getAvailableIntents(e.intentNames,e.mode),o=yield t.next?.handle(e);return t._isObjectResponse(o)?{...s,...o}:s})()}};se=(0,r.__decorate)([(0,i.CrtRequestHandler)({type:"crt.CopilotGetAvailableIntentsHandler",requestType:"crt.CopilotGetAvailableIntentsRequest"}),(0,r.__metadata)("design:paramtypes",[d.Injector])],se);var Te=u(29957);let oe=class extends i.BaseRequestHandler{constructor(e){super(),this._copilotPanelCode="Copilot",this._copilotToEditorCommunicationService=e.get(h.CopilotToEditorCommunicationService)}handle(e){var t=this;return(0,a.A)(function*(){e.sidebarCode===t._copilotPanelCode&&t._copilotToEditorCommunicationService.notify({editorAction:h.EditorActionType.RemoveHighlighting,selection:Te.String.empty}),yield t.next?.handle(e)})()}};oe=(0,r.__decorate)([(0,i.CrtRequestHandler)({type:"crt.CopilotClosePanelHandler",requestType:"crt.HandleSidebarCloseRequest"}),(0,r.__metadata)("design:paramtypes",[d.Injector])],oe);let ne=class extends i.BaseRequestHandler{constructor(e){super(),this._copilotToEditorCommunicationService=e.get(h.CopilotToEditorCommunicationService)}handle(e){var t=this;return(0,a.A)(function*(){t._copilotToEditorCommunicationService?.notify({editorAction:h.EditorActionType.RemoveHighlighting}),yield t.next?.handle(e)})()}};ne=(0,r.__decorate)([(0,i.CrtRequestHandler)({type:"crt.CopilotViewModelPauseHandler",requestType:"crt.HandleViewModelPauseRequest"}),(0,r.__metadata)("design:paramtypes",[d.Injector])],ne);const Oe={"hr-HR":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"bg-BG":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"hu-HU":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"zh-CN":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"uk-UA":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"sq-AL":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"zh-TW":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"no-NO":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),zh:JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"vi-VN":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"tr-TR":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"th-TH":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"sv-SE":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"ro-RO":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"pt-PT":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"pt-BR":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"pl-PL":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),no:JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"nl-NL":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"lv-LV":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"ko-KR":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"kk-KZ":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"ja-JP":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"it-IT":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"id-ID":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"he-IL":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"fr-FR":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"fr-CA":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"fa-IR":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"es-ES":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"de-DE":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"cs-CZ":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"ar-SA":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"en-US":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{"AskCopilot":"You will assist with rewriting the following text, further instructions will be provided in the dialog","Friendly":"Rewrite the following text and make it more friendly","Formal":"Rewrite the following text and make it more formal","Shorten":"Rewrite the following text and shorten it","Extend":"Rewrite the following text and extend it","Rephrase":"Rewrite the following text and rephrase it"}}}'),"ru-RU":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{"AskCopilot":"\u0422\u044B \u0431\u0443\u0434\u0435\u0448\u044C \u043F\u043E\u043C\u043E\u0433\u0430\u0442\u044C \u043F\u0435\u0440\u0435\u043F\u0438\u0441\u044B\u0432\u0430\u0442\u044C \u0442\u0435\u043A\u0441\u0442, \u043F\u0440\u0438\u0432\u0435\u0434\u0435\u043D\u043D\u044B\u0439 \u043D\u0438\u0436\u0435, \u0434\u0430\u043B\u044C\u043D\u0435\u0439\u0448\u0438\u0435 \u0438\u043D\u0441\u0442\u0440\u0443\u043A\u0446\u0438\u0438 \u0431\u0443\u0434\u0443\u0442 \u0432 \u0434\u0438\u0430\u043B\u043E\u0433\u0435","Friendly":"\u041F\u0435\u0440\u0435\u043F\u0438\u0448\u0438 \u0442\u0435\u043A\u0441\u0442 \u043D\u0438\u0436\u0435 \u0438 \u0441\u0434\u0435\u043B\u0430\u0439 \u0435\u0433\u043E \u0431\u043E\u043B\u0435\u0435 \u0434\u0440\u0443\u0436\u0435\u043B\u044E\u0431\u043D\u044B\u043C","Formal":"\u041F\u0435\u0440\u0435\u043F\u0438\u0448\u0438 \u0442\u0435\u043A\u0441\u0442 \u043D\u0438\u0436\u0435 \u0438 \u0441\u0434\u0435\u043B\u0430\u0439 \u0435\u0433\u043E \u0431\u043E\u043B\u0435\u0435 \u0444\u043E\u0440\u043C\u0430\u043B\u044C\u043D\u044B\u043C","Shorten":"\u041F\u0435\u0440\u0435\u043F\u0438\u0448\u0438 \u0442\u0435\u043A\u0441\u0442 \u043D\u0438\u0436\u0435 \u0438 \u0443\u043A\u043E\u0440\u043E\u0442\u0438 \u0435\u0433\u043E","Extend":"\u041F\u0435\u0440\u0435\u043F\u0438\u0448\u0438 \u0442\u0435\u043A\u0441\u0442 \u043D\u0438\u0436\u0435 \u0438 \u0443\u0434\u043B\u0438\u043D\u0438 \u0435\u0433\u043E","Rephrase":"\u041F\u0435\u0440\u0435\u043F\u0438\u0448\u0438 \u0442\u0435\u043A\u0441\u0442 \u043D\u0438\u0436\u0435 \u0438 \u043F\u0435\u0440\u0435\u0444\u0440\u0430\u0437\u0438\u0440\u0443\u0439 \u0435\u0433\u043E"}}}')};let T=class ie{static{this.\u0275fac=function(t){return new(t||ie)}}static{this.\u0275mod=d.\u0275\u0275defineNgModule({type:ie})}static{this.\u0275inj=d.\u0275\u0275defineInjector({providers:[j.UserConsentService,v],imports:[N.CopilotUtilsModule,ae.CopilotIntentSchemaDesignerApiModule,b.CrtLibTranslateModule.forRoot({i18n:Oe})]})}};T=(0,r.__decorate)([(0,i.CrtModule)({viewElements:[],requestHandlers:[K,J,oe,ne,z,Z,q,Y,V,G,F,$,te,W,w,X,ee,se,Q],converters:[H]})],T),function(){(typeof ngJitMode>"u"||ngJitMode)&&d.\u0275\u0275setNgModuleScope(T,{imports:[N.CopilotUtilsModule,ae.CopilotIntentSchemaDesignerApiModule,b.CrtLibTranslateModule]})}()}}]);
