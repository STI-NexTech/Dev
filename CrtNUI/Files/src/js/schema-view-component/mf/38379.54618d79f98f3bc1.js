(self.webpackChunkapp_studio_enterprise_schema_view=self.webpackChunkapp_studio_enterprise_schema_view||[]).push([[38379,60760],{38379:(M,S,c)=>{c.r(S),c.d(S,{CopilotIntentSchemaDesignerApiModule:()=>h});var C=c(5960),I=c(40297),o=c(59131),f=c(38495),s=c(5114),p=c(21018),g=c(95868),v=c(85638),a=c(62278);class y extends s.BaseSchema{}class T{constructor(){this.caption=new p.LocalizableStringArray,this.description=new p.LocalizableStringArray}}class d extends s.BaseSchemaConverterService{constructor(t,e){super(y),this._userInfo=t,this._resourceFinderService=e,this._sysCultureName=this._userInfo.cultureInfo.sysCultureName}_convertSchemaActionToDto(t,e){return e.actions?.map(r=>({Id:r.uid,Code:r.name,Intent:{value:t},ActionType:r.actionSchemaTypeUId,Name:this._resourceFinderService.findLocalizableValue(r.caption),Description:this._resourceFinderService.findLocalizableValue(r.description),Params:r.params,PackageUId:e.package.uId}))}_convertDtoActionToSchema(t,e){const r=t.actions||[],N=e.filter(i=>r.every(n=>n.uid!==i.Id)).map(i=>{const n=new T;return n.uid=i.Id,n.name=i.Code,n.params=i.Params,n.actionSchemaTypeUId=i.ActionType,n.caption.setValueLocalizableString(this._sysCultureName,i.Name),n.description.setValueLocalizableString(this._sysCultureName,i.Description),n}),_=r.filter(i=>e.some(n=>n.Id===i.uid)).map(i=>{const n=e.find(D=>D.Id===i.uid);return i.name=n.Code,i.caption.setValueLocalizableString(this._sysCultureName,n.Name),i.description.setValueLocalizableString(this._sysCultureName,n.Description),i.params=n.Params,i.actionSchemaTypeUId=n.ActionType,i});t.actions=[...N,..._]}createSchema(t){const e=super.createSchema(t);return e.caption=new p.LocalizableStringArray(t.caption),e.description=new p.LocalizableStringArray(t.description),e.actions=t.actions?.map(r=>(r.description=new p.LocalizableStringArray(r.description),r.caption=new p.LocalizableStringArray(r.caption),r)),e}convertToSchema(t){return this.createSchema(t)}mapModelToSchema(t,e){return t.prompt=e.Prompt,t.intentDescription=e.Description,t.caption.setValueLocalizableString(this._sysCultureName,e.Title),t.name=e.Code,t.status=e.Status,t.mode=e.Mode,this._convertDtoActionToSchema(t,e.Actions),t}schemaToModel(t,e){return{UId:t,Title:this._resourceFinderService.findLocalizableValue(e.caption),Code:e.name,Description:e.intentDescription||this._resourceFinderService.findLocalizableValue(e.description),Prompt:e.prompt,Status:e.status,Type:e.type,Actions:this._convertSchemaActionToDto(t,e),ExtendParent:e.extendParent,PackageUId:e.package.uId,Mode:e.mode}}static{this.\u0275fac=function(e){return new(e||d)(o.\u0275\u0275inject(p.UserInfo),o.\u0275\u0275inject(p.ResourceFinderService))}}static{this.\u0275prov=o.\u0275\u0275defineInjectable({token:d,factory:d.\u0275fac})}}class u extends s.BaseDesignerApiService{constructor(t){super(t)}static{this.\u0275fac=function(e){return new(e||u)(o.\u0275\u0275inject(o.Injector))}}static{this.\u0275prov=o.\u0275\u0275defineInjectable({token:u,factory:u.\u0275fac})}}class l extends v.BaseCachedService{constructor(){super(),this._apiService=(0,o.inject)(u),this._convertor=(0,o.inject)(d),this._currentPackageService=(0,o.inject)(s.CurrentPackageApiService),this._serverClientOperationNotificationReceiver=(0,o.inject)(v.ServerClientOperationNotificationReceiver),this._copilotIntentChangedSubscribe()}_copilotIntentChangedSubscribe(){this._serverClientOperationNotificationReceiver.getNotifications("CopilotIntentChanged").subscribe(t=>this.deleteFromCache(t.intentUId))}_normalizeUId(t){return t.toLocaleLowerCase()}_getIntentSchema(t){return this._apiService.getSchema({schemaUId:t,useFullHierarchy:!0}).pipe((0,a.map)(e=>{if(!e.success)throw new Error(e.errorInfo?.message||`Failed to get schema with UId: ${t}`);return e.schema}),(0,a.shareReplay)({bufferSize:1,refCount:!1}),(0,a.catchError)(e=>(0,a.throwError)(()=>e)))}setToCache(t,e){super.setToCache(this._normalizeUId(t),e)}getFromCache(t){return super.getFromCache(this._normalizeUId(t))}deleteFromCache(t){return super.deleteFromCache(this._normalizeUId(t))}get(t){let e=this.getFromCache(t);return e||(e=this._getIntentSchema(t),this.setToCache(t,e)),e.pipe((0,a.map)(r=>this._convertor.schemaToModel(t,r)))}update(t){return this.getFromCache(t.UId).pipe((0,a.map)(e=>this._convertor.mapModelToSchema(e,t)),(0,a.switchMap)(e=>this._apiService.saveSchema(e)),(0,a.tap)(e=>{e.success||this.deleteFromCache(t.UId)}))}create(t){return this._currentPackageService.getDesignPackageUId(null).pipe((0,a.switchMap)(e=>this._apiService.createSchema({packageUId:e.uId,extendParent:!1,schemaUId:t})),(0,a.map)(e=>e.schema),(0,a.tap)(e=>this.setToCache(t,(0,a.of)(e))),(0,a.map)(e=>this._convertor.schemaToModel(t,e)))}static{this.\u0275fac=function(e){return new(e||l)}}static{this.\u0275prov=o.\u0275\u0275defineInjectable({token:l,factory:l.\u0275fac})}}let h=class m{static{this.\u0275fac=function(e){return new(e||m)}}static{this.\u0275mod=o.\u0275\u0275defineNgModule({type:m})}static{this.\u0275inj=o.\u0275\u0275defineInjector({providers:[{provide:g.COPILOT_INTENT_REPOSITORY_TOKEN,useClass:l},{provide:u,useFactory:t=>{const e=o.Injector.create({name:"CopilotIntentSchemaDesignerApiInjector",parent:t,providers:[(0,s.getSchemaDesignerApiUrlProvider)("CopilotIntentSchemaDesignerService.svc"),{provide:s.SCHEMA_DESIGNER_CONVERTER,useClass:d,deps:[p.UserInfo]},{provide:s.OPTIONS_SKIP_UNSUCCESSFUL_RESPONSE_HANDLING,useValue:!0}]});return new u(e)},deps:[o.Injector]},d],imports:[I.CommonModule,s.SchemaDesignerApiModule]})}};h=(0,C.__decorate)([(0,f.CrtModule)({})],h),function(){(typeof ngJitMode>"u"||ngJitMode)&&o.\u0275\u0275setNgModuleScope(h,{imports:[I.CommonModule,s.SchemaDesignerApiModule]})}()}}]);
