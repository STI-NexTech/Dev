"use strict";(self.webpackChunkapp_studio_enterprise_schema_view=self.webpackChunkapp_studio_enterprise_schema_view||[]).push([[871],{57252:(yt,be,C)=>{C.r(be),C.d(be,{CopilotChatService:()=>w,CopilotModule:()=>F,CopilotService:()=>oe});var h=C(97270),c=C(44537),T=C(96590),P=C(69244),H=C(76696),o=C(99314),y=C(24677),d=C(16837),Qe=C(9461),l=C(96091),f=C(93527),x=C(37782),O=C(34526),Ye=C(54807);const Me=new o.InjectionToken("OptionsSkipUnsuccessfulResponseHandling"),Ne=new o.InjectionToken("SchemaDesignerApiUrl");class b{constructor(e){e&&(this.uId=e.uId,this.name=e.name,this.parentSchemaUId=e.parentSchemaUId),this.uId=this.uId||(0,c.generateGuid)()}update(e){this.uId=e.uId,this.name=e.name}equal(e){if(e==null)return!1;let t=this.uId===e.uId&&this.name===e.name;return(this.parentSchemaUId||e.parentSchemaUId)&&(t=t&&this.parentSchemaUId===e.parentSchemaUId),t}clone(){return new b(this)}getLocalizableValues(e){}loadLocalizableValues(e,t=!1){}}class D{constructor(e,t){this.name=e,this.uId=t}equal(e){return e==null?!1:this.uId===e.uId&&this.name===e.name&&this.type===e.type&&this.isChanged===e.isChanged&&this.isLocked===e.isLocked}clone(){const e=new D(this.name,this.uId);return e.type=this.type,e.isChanged=this.isChanged,e.isLocked=this.isLocked,e}}class We extends b{constructor(e){if(super(e),this.isReadOnly=!1,this.useFullHierarchy=!1,this.addonTypes=[],this.addons=[],e){if(this.id=e.id,e.package){const t=e.package;t.clone?this.package=t.clone():(this.package=new D(t.name,t.uId),this.package.type=t.type,this.package.isChanged=t.isChanged,this.package.isLocked=t.isLocked)}if(this.body=e.body,this.isReadOnly=e.isReadOnly,this.useFullHierarchy=e.useFullHierarchy,this.parentSchema=e.parentSchema,this.extendParent=e.extendParent,e.dependencies){const t=e.dependencies;let s=t.requiredSchemas;s&&(s=[...s]);let n=t.requiredEntityColumns;n&&(n=n.map(i=>({entitySchemaName:i.entitySchemaName,columnPaths:[...i.columnPaths]}))),this.dependencies={requiredSchemas:s,requiredEntityColumns:n}}}}updateDescription(e){super.update(e),this.id=e.id,this.package=e.package}equal(e){if(e==null)return!1;let t=super.equal(e)&&this.id===e.id&&this.body===e.body&&this.isReadOnly===e.isReadOnly&&this.useFullHierarchy===e.useFullHierarchy;return(this.package||e.package)&&(t=t&&this.package?.equal(e.package)),t}getLocalizableValues(e){super.getLocalizableValues(e)}loadLocalizableValues(e,t=!1){super.loadLocalizableValues(e,t)}}class At extends b{constructor(e){super(e),e&&(this.caption=e.caption)}}class bt extends null{}class G extends b{constructor(e){super(e),this.values=new d.hd5(e?.values)}clone(){return new G(this)}getLocalizableValues(e){super.getLocalizableValues(e),e.values=this.values.clone()}loadLocalizableValues(e,t=!1){super.loadLocalizableValues(e,t),this.values.setValues(e.values,t)}}class _ extends Array{constructor(e){super(),e&&Array.isArray(e)&&(this.push(...e.map(t=>t.clone())),this.uId=e.uId),this.uId=this.uId||(0,c.generateGuid)()}deleteItemByUId(e){const t=this.findItemIndex(e);return t<0?!1:(this.splice(t,1),!0)}findItemIndex(e){return this.findIndex(t=>t.uId===e)}findItem(e){return this.find(t=>t.uId===e)}addItem(e){this.unshift(e)}reloadAll(e){this.splice(0,this.length,...e||[])}equal(e){return e==null||this.length!==e?.length?!1:this.every(t=>{const s=e?.findItem(t.uId);return t.equal(s)})}clone(){return new _(this)}getLocalizableValues(e,t){this.forEach(s=>{const n={};s.getLocalizableValues(n),Object.entries(n).forEach(([i,r])=>{e[`${t}.${s.name}.${i}`]=r})})}loadLocalizableValues(e,t,s=!1){const n={};Object.entries(e).map(([i,r])=>{const p=i.split("."),S=p.shift(),m=p.shift(),g=p.join(".");return{itemGroupName:S,itemName:m,itemResourceName:g,values:r}}).filter(({itemGroupName:i})=>i===t).forEach(({itemName:i,itemResourceName:r,values:p})=>{const S=n[i]??{};S[r]=p,n[i]=S}),Object.entries(n).forEach(([i,r])=>{this.find(S=>S.name===i).loadLocalizableValues(r,s)})}}var Ke=function(a){return a[a.Success=0]="Success",a[a.Error=1]="Error",a[a.NoChanges=2]="NoChanges",a}(Ke||{});class L extends We{constructor(e){super(e),this.caption=new d.hd5,this.description=new d.hd5,this.localizableStrings=new _,e&&(this.caption=e.caption?e.caption.clone():e.caption,this.description=e.description?e.description.clone():e.description,this.localizableStrings=e.localizableStrings?e.localizableStrings.clone():e.localizableStrings)}get DefaultName(){return"BaseSchema"}findChildrenItem(e){return this.localizableStrings.findItem(e)}findGroup(e){return this.localizableStrings.uId===e?this.localizableStrings:null}updateDescription(e){super.updateDescription(e),this.caption=new d.hd5(e.caption),this.description=new d.hd5(e.description)}getIsOwnMetaItem(e){return this.uId===e.parentSchemaUId}equal(e){return e==null?!1:super.equal(e)&&(0,d.$nD)(this.caption,e.caption,!0)&&(0,d.$nD)(this.description,e.description,!0)}clone(){return new L(this)}getLocalizableValues(e){super.getLocalizableValues(e),e.caption=this.caption.clone(),e.description=this.description.clone(),this.localizableStrings.getLocalizableValues(e,"localizableStrings")}loadLocalizableValues(e,t=!1){super.loadLocalizableValues(e,t),this.caption.setValues(e.caption,t),this.description.setValues(e.description,t),this.localizableStrings.loadLocalizableValues(e,"localizableStrings",t)}}const Pe=new o.InjectionToken("SchemaDesignerConverter");class B extends b{constructor(e){super(e),this.isChanged=!1,e&&(this._data=e.data||{},this.image=e.image,this.caption=new d.hd5(e.caption)),this.caption||(this.caption=new d.hd5)}get data(){return this._data}get image(){return this.data?.name}set image(e){!e||e===this.data?.name||Object.assign(this._data,{name:e})}static _getIsFileChanged(e,t){const s=e?.name,n=t?.name,i=s&&!n,r=n&&!s,p=n&&s&&t.size>0;return r||i||p}updateFile(e){this.isChanged=B._getIsFileChanged(this.data,e),this._data=e}clone(){return new B(this)}getLocalizableValues(e){super.getLocalizableValues(e),e.caption=this.caption.clone()}loadLocalizableValues(e,t=!1){super.loadLocalizableValues(e,t),this.caption.setValues(e.caption,t)}}class Re extends L{_findNestedProperties(e,t){const s=t.find(n=>n.uId===e);return s?s.itemProperties:null}_getNestedParametersGroup(e,t){return(0,d.oQk)(t,s=>this._findNestedProperties(e,s),s=>s.itemProperties)}_getParametersGroup(e,t){let s=this._getNestedParametersGroup(e,t);return s||(s=this.parameters.uId===e?this.parameters:null),s}_getParameter(e,t){return(0,d.x3G)(t,s=>s.uId===e,s=>s.itemProperties)}constructor(e){super(e),this.parameters=new _,e&&(this.parameters=e.parameters.clone())}findChildrenItem(e){return this._getParameter(e,this.parameters)||super.findChildrenItem(e)}findGroup(e){const t=this._getParametersGroup(e,this.parameters);return t||super.findGroup(e)}findNestedParametersGroup(e){return this._getNestedParametersGroup(e,this.parameters)||this.parameters}findParameterByUId(e){return this._getParameter(e,this.parameters)}clone(){return new Re(this)}getLocalizableValues(e){super.getLocalizableValues(e),this.parameters.getLocalizableValues(e,"parameters")}loadLocalizableValues(e,t=!1){super.loadLocalizableValues(e,t),this.parameters.loadLocalizableValues(e,"parameters",t)}}class V extends b{constructor(e){super(e),e&&(this.caption=new d.hd5(e.caption),this.type=e.type,this.lookup=e.lookup,this.schema=e.schema,this.resulting=e.resulting,this.required=e.required,this.containsPerformerId=e.containsPerformerId,this.copyValue=e.copyValue,this.serializable=e.serializable,this.lazyLoad=e.lazyLoad,this.value=e.value,this.itemProperties=this._mapItemArray(e.itemProperties))}static updateLookupValue(e,t,s){const n=e[s]?e[s].key:null;n?t[s]=n:delete t[s]}_getSourceType(e){return e.type?.key}_mapItemArray(e){return e?new _(e.map(t=>new V(t))):new _}_resetItemProperties(e){this.type!==e&&(this.itemProperties=new _,this.itemProperties.uId=this.uId)}updateDescription(e){this.caption=e.caption,this.name=e.name;const t=this._getSourceType(e);this._resetItemProperties(t),this.type=t,V.updateLookupValue(e,this,"lookup"),this.schema=e.schema,this.resulting=e.resulting,this.required=e.required,this.containsPerformerId=e.containsPerformerId,this.copyValue=e.copyValue,this.serializable=e.serializable,this.lazyLoad=e.lazyLoad,this.value=e.value}clone(){return new V(this)}getLocalizableValues(e){super.getLocalizableValues(e),e.caption=this.caption.clone(),this.itemProperties.getLocalizableValues(e,"itemProperties")}loadLocalizableValues(e,t=!1){super.loadLocalizableValues(e,t),this.caption.setValues(e.caption,t),this.itemProperties.loadLocalizableValues(e,"itemProperties",t)}}var Ee=C(55233),Te=C(37236);class J extends d.DQf{constructor(e){super(e),this.typeName="Terrasoft.Core.Addons.AddonSchema",this.metaData=e.metaData,this.addonName=e.addonName,this.targetSchemaUId=e.targetSchemaUId,this.targetSchemaManagerName=e.targetSchemaManagerName,this.typeName=e.typeName,this.id=e.id,this.parentSchemaUId=e.parentSchemaUId,this.package=e.package,this.resources=e.resources}clone(){return new J(this)}set addonConfig(e){this.metaData=JSON.stringify(e,null,"	")}get addonConfig(){try{return JSON.parse(this.metaData)}catch{throw new Error("Invalid addon JSON metadata received from server")}}equal(e){return this.metaData===e.metaData&&this.addonName===e.addonName&&this.targetSchemaManagerName===e.targetSchemaManagerName&&this.targetSchemaUId===e.targetSchemaUId&&this.typeName===e.typeName&&this.extendParent===e.extendParent&&this.uId===e.uId&&this.name===e.name&&this.packageUId===e.packageUId&&this.caption===e.caption&&this.id===e.id&&this.parentSchemaUId===e.parentSchemaUId}}class k{constructor(...e){if(this._isLoaded=!1,this._isChanged=!1,this.id=(0,c.generateGuid)(),e[0]instanceof k){const t=e[0];this.addonName=t.addonName,this._targetSchemaUId=t.targetSchemaUId,this.targetSchemaManagerName=t.targetSchemaManagerName,this.targetParentSchemaUId=t.targetParentSchemaUId,this.targetPackageUId=t.targetPackageUId,this.id=t.id,this._apiService=t._apiService,this._isLoaded=t._isLoaded,this._isChanged=t._isChanged,t._schema&&(this._schema=t._schema.clone()),this.useFullHierarchy=t.useFullHierarchy}else this.addonName=e[0],this._targetSchemaUId=e[1],this.targetParentSchemaUId=e[2],this.targetPackageUId=e[3],this.targetSchemaManagerName=e[4],this._apiService=e[5],this.useFullHierarchy=e[6]}get targetSchemaUId(){return this._targetSchemaUId}set targetSchemaUId(e){this._targetSchemaUId=e,this._schema&&(this._schema.targetSchemaUId=e)}get schema$(){return this._isLoaded?(0,l.of)(this._schema):this._loadSchema()}get addonConfig(){return this.schema$.pipe((0,f.T)(e=>{const t=e.addonConfig;return this._setMetadataDefValues(t),t}))}set addonConfig(e){(0,l.forkJoin)([this.schema$,e]).subscribe(([t,s])=>{t.addonConfig=s,this._isChanged=!0})}get isChanged(){return this._isChanged}get resources(){return this._resources}_setMetadataDefValues(e){this.addonName===d.ub_.BusinessRule&&e.rules?.forEach(s=>{s.name=s.name||(0,Ee.hK)(),s.enabled=s.enabled||s.enabled===void 0})}_setAddonResources(e){this._resources=e.map(t=>{const s=t.key.split(".");return{key:[s[2],s[3]].join("."),value:t.value}}),this._schema.resources=[...this._resources]}_loadSchema(){return this._schema$?this._schema$:(this._schema$=this._apiService.getAddon({targetSchemaUId:this.targetSchemaUId,addonName:this.addonName,targetParentSchemaUId:this.targetParentSchemaUId,targetPackageUId:this.targetPackageUId,targetSchemaManagerName:this.targetSchemaManagerName,useFullHierarchy:this.useFullHierarchy}).pipe((0,Te.M)(e=>{e.success&&(this._schema=new J(e.schema),this._schema.typeName="Terrasoft.Core.Addons.AddonSchema",this._isLoaded=!0,this._setAddonResources(e.schema.resources??[]))}),(0,f.T)(()=>this._schema),(0,x.u)()),this._schema$)}save(){return this._isLoaded?this._apiService.saveAddon(this._schema).pipe((0,f.T)(e=>e.success),(0,Te.M)(()=>{this._isChanged=!1})):(0,l.of)(!0)}clone(){return new k(this)}equal(e){let t=this._isLoaded===e._isLoaded&&e.targetSchemaUId===this.targetSchemaUId&&e.addonName===this.addonName&&this.targetSchemaManagerName===e.targetSchemaManagerName;return t&&this._isLoaded&&(t=this._schema.equal(e._schema)),t}createOrUpdateResource(e){const t=this.resources.findIndex(s=>s.key===e.key);t===-1?this.resources.push(e):this.resources.splice(t,1,e),this._schema.resources=[...this._resources]}removeResource(e){const t=this.resources.findIndex(s=>s.key===e);this.resources.splice(t,1),this._schema.resources=[...this._resources]}}var j=function(a){return a[a.NO=0]="NO",a[a.YES=1]="YES",a}(j||{});const Mt={[j.NO]:{type:j.NO,name:"No"},[j.YES]:{type:j.YES,name:"Yes"}};let xe=(()=>{class a{constructor(t){this.getAddonMethodName="GetSchema",this.saveAddonMethodName="SaveSchema",this.serviceEndpoint="/ServiceModel/AddonSchemaDesignerService.svc/",this._httpClient=t.get(y.HttpClient),this._workplaceService=t.get(d.sGI)}getAddon(t){const s=`${this.serviceEndpoint}${this.getAddonMethodName}`;return this._httpClient.post(s,t)}saveAddon(t){const s=`${this.serviceEndpoint}${this.saveAddonMethodName}`;return this._httpClient.post(s,t).pipe((0,l.switchMap)(n=>this._workplaceService.resetWorkplaceScriptCache().pipe((0,f.T)(()=>n))))}static{this.\u0275fac=function(s){return new(s||a)(o.\u0275\u0275inject(o.Injector))}}static{this.\u0275prov=o.\u0275\u0275defineInjectable({token:a,factory:a.\u0275fac})}}return a})(),Oe=(()=>{class a{constructor(t){this._apiService=t.get(xe),this._features=t.get(d.G2Y,{optional:!0})}_getParentSchemaUId(t){const s=t.parentSchema??t.parent;return s?.name===t.name?s.uId:c.EMPTY_GUID}create(t,s){return!t.addonTypes||t.addonTypes.length===0?[]:t.addonTypes.map(n=>{const i=this._getParentSchemaUId(t);return this.createAddonInfo(t,n,i,s)})}createAddonInfo(t,s,n,i){return new k(s,t.uId,n,t.package.uId,i,this._apiService,t.useFullHierarchy)}static{this.\u0275fac=function(s){return new(s||a)(o.\u0275\u0275inject(o.Injector))}}static{this.\u0275prov=o.\u0275\u0275defineInjectable({token:a,factory:a.\u0275fac})}}return a})();const Ze=a=>`/ServiceModel/${a}/`,Xe=(a,e)=>({multi:!1,provide:e,useValue:Ze(a)}),et=a=>Xe(a,Ne);let tt=(()=>{class a extends P.tq{get converter(){return this._converter}constructor(t){super(),this._restErrorHandleOptions={},this.createNewSchemaMethodName="CreateNewSchema",this.getSchemaMethodName="GetSchema",this.saveSchemaMethodName="SaveSchema",this.serviceEndpoint=t.get(Ne),this._converter=t.get(Pe,null,{optional:!0}),this._addonInfoFactory=t.get(Oe),this._errorHandler=t.get(d.xsE),this._restErrorHandleOptions.skipUnsuccessfulResponse=t.get(Me,!1,{optional:!0})}getSchemaManagerName(){return null}getSchemaFromService(t,s,n=!1){const i=n?{headers:new y.HttpHeaders({"Content-Type":"application/json"})}:{};return this.httpClient.post(t,s,i).pipe((0,f.T)(r=>{if(r.schema){const p=this.getSchemaManagerName();return r.schema=this.convertToObject(r.schema),r.schema.addons=this._addonInfoFactory.create(r.schema,p),r}return r}),(0,x.u)())}getSchemasFromService(t,s,n=!1){const i=n?{headers:new y.HttpHeaders({"Content-Type":"application/json"})}:{};return this.httpClient.post(t,s,i).pipe((0,f.T)(r=>{if(r.schemas){const p=this.getSchemaManagerName();return r.schemas.forEach((S,m)=>{r.schemas[m]=this.convertToObject(S),r.schemas[m].addons=this._addonInfoFactory.create(S,p)}),r}return r}),(0,x.u)())}createObject(t,s){return Object.assign(new t,s)}convertToObject(t){return this._converter.convertToSchema(t)}convertSchemaToDTO(t){return t}_addonSaveHandler(t){const s=t.save();return this._errorHandler.handleRequest(s,this._restErrorHandleOptions).pipe((0,O.W)(()=>(0,l.of)(!1)),(0,f.T)(n=>({message:`Addon ${t.addonName} was ${n?"successfully":"not"} saved!`,result:n})))}_saveAddons(t){return(0,l.forkJoin)(t.map(s=>this._addonSaveHandler(s))).pipe((0,f.T)(s=>{const n=s.filter(i=>!i.result).map(i=>i.message);return n.length>0?n:null}))}createSchema(t){const s=`${this.serviceEndpoint}${this.createNewSchemaMethodName}`;return this.getSchemaFromService(s,t)}getSchema(t){const s=`${this.serviceEndpoint}${this.getSchemaMethodName}`;return this.getSchemaFromService(s,t)}saveSchema(t,s=!1){s&&(t.useFullHierarchy=!0);const n=`${this.serviceEndpoint}${this.saveSchemaMethodName}`,i=t.addons?[...t.addons]:null,r=(0,Qe.A)(t,["addons"]),p=this.httpClient.post(n,r);return this._errorHandler.handleRequest(p,this._restErrorHandleOptions).pipe((0,Ye.H)(m=>{const g=i?.filter(I=>I.isChanged);return m.success&&g?.length>0?this._saveAddons(g).pipe((0,f.T)(I=>({...m,addonsErrors:I}))):(0,l.of)(m)}),(0,x.u)())}checkUniqueSchemaName(t,s,n){const i=this.serviceEndpoint+"CheckUniqueSchemaName",r={schemaName:t,excludeUId:s,managerName:n};return this.httpClient.post(i,r,{headers:new y.HttpHeaders({"Content-Type":"application/json"})}).pipe((0,x.u)())}static{this.\u0275fac=function(s){return new(s||a)(o.\u0275\u0275inject(o.Injector))}}static{this.\u0275prov=o.\u0275\u0275defineInjectable({token:a,factory:a.\u0275fac,providedIn:"root"})}}return a})();class st{constructor(e){this.factory=e}createSchema(e){const t=new this.factory;return Object.assign(t,e),e.package&&(t.package=new D(e.package.name,e.package.uId),t.package.type=e.package.type,t.package.isChanged=e.package.isChanged,t.package.isLocked=e.package.isLocked),t}createLocalizableStrings(e){if(!e)return new _;const t=e.map(s=>new G(s));return new _(t)}}const nt=new o.InjectionToken("SchemaImageUploaderApiUrl"),Nt=a=>({multi:!1,provide:nt,useValue:`/ServiceModel/${a}`});let Pt=null,Rt=null,at=(()=>{class a{constructor(t){this._httpClient=t,this._appInstallerServiceUrl="ServiceModel/AppInstallerService.svc/",this._getDesignPackageUId="GetDesignPackageUId"}getDesignPackageUId(t){const s=`${this._appInstallerServiceUrl}${this._getDesignPackageUId}`;return this._httpClient.post(s,{schemaUId:t})}static{this.\u0275fac=function(s){return new(s||a)(o.\u0275\u0275inject(y.HttpClient))}}static{this.\u0275prov=o.\u0275\u0275defineInjectable({token:a,factory:a.\u0275fac,providedIn:"root"})}}return a})();class je{copy(e){return{...e}}isEmpty(e){return!1}}class it extends je{copy(e){const t=e.metadata,s=[],n=[];return t.rules.forEach(i=>{const r=new Ee.RR(i,new d.hd5,null,null,null),{uId:p,name:S}=r,m=r.copy();m.name=S;const g=m.uId,I=(e.resources||[]).find($=>$.key?.includes(p));if(I){const $=I.key.replace(p,g);n.push({...I,key:$})}s.push(m.toMetadata())}),{metadata:{...e.metadata,rules:s},name:e.name,resources:n}}isEmpty(e){return!e.metadata?.rules||e.metadata.rules?.length===0}}let rt=(()=>{class a{create(t){return t===d.ub_.BusinessRule?new it:new je}static{this.\u0275fac=function(s){return new(s||a)}}static{this.\u0275prov=o.\u0275\u0275defineInjectable({token:a,factory:a.\u0275fac})}}return a})(),q=(()=>{class a{static{this.\u0275fac=function(s){return new(s||a)}}static{this.\u0275mod=o.\u0275\u0275defineNgModule({type:a})}static{this.\u0275inj=o.\u0275\u0275defineInjector({providers:[xe,Oe,rt],imports:[H.CommonModule]})}}return a})();(function(){(typeof ngJitMode>"u"||ngJitMode)&&o.\u0275\u0275setNgModuleScope(q,{imports:[H.CommonModule]})})();var R=C(51170);class ot extends L{}class ct{constructor(){this.caption=new d.hd5,this.description=new d.hd5}}let Q=(()=>{class a extends st{constructor(t,s){super(ot),this._userInfo=t,this._resourceFinderService=s,this._sysCultureName=this._userInfo.cultureInfo.sysCultureName}_convertSchemaActionToDto(t,s){return s.actions?.map(n=>({Id:n.uid,Code:n.name,Intent:{value:t},ActionType:n.actionSchemaTypeUId,Name:this._resourceFinderService.findLocalizableValue(n.caption),Description:this._resourceFinderService.findLocalizableValue(n.description),Params:n.params,PackageUId:s.package.uId}))}_convertDtoActionToSchema(t,s){const n=t.actions||[],r=s.filter(m=>n.every(g=>g.uid!==m.Id)).map(m=>{const g=new ct;return g.uid=m.Id,g.name=m.Code,g.params=m.Params,g.actionSchemaTypeUId=m.ActionType,g.caption.setValueLocalizableString(this._sysCultureName,m.Name),g.description.setValueLocalizableString(this._sysCultureName,m.Description),g}),S=n.filter(m=>s.some(g=>g.Id===m.uid)).map(m=>{const g=s.find(I=>I.Id===m.uid);return m.name=g.Code,m.caption.setValueLocalizableString(this._sysCultureName,g.Name),m.description.setValueLocalizableString(this._sysCultureName,g.Description),m.params=g.Params,m.actionSchemaTypeUId=g.ActionType,m});t.actions=[...r,...S]}createSchema(t){const s=super.createSchema(t);return s.caption=new d.hd5(t.caption),s.description=new d.hd5(t.description),s.actions=t.actions?.map(n=>(n.description=new d.hd5(n.description),n.caption=new d.hd5(n.caption),n)),s}convertToSchema(t){return this.createSchema(t)}mapModelToSchema(t,s){return t.prompt=s.Prompt,t.intentDescription=s.Description,t.caption.setValueLocalizableString(this._sysCultureName,s.Title),t.name=s.Code,t.status=s.Status,t.mode=s.Mode,this._convertDtoActionToSchema(t,s.Actions),t}schemaToModel(t,s){return{UId:t,Title:this._resourceFinderService.findLocalizableValue(s.caption),Code:s.name,Description:s.intentDescription||this._resourceFinderService.findLocalizableValue(s.description),Prompt:s.prompt,Status:s.status,Type:s.type,Actions:this._convertSchemaActionToDto(t,s),ExtendParent:s.extendParent,PackageUId:s.package.uId,Mode:s.mode}}static{this.\u0275fac=function(s){return new(s||a)(o.\u0275\u0275inject(d.oqB),o.\u0275\u0275inject(d.Qhy))}}static{this.\u0275prov=o.\u0275\u0275defineInjectable({token:a,factory:a.\u0275fac})}}return a})(),Y=(()=>{class a extends tt{constructor(t){super(t)}static{this.\u0275fac=function(s){return new(s||a)(o.\u0275\u0275inject(o.Injector))}}static{this.\u0275prov=o.\u0275\u0275defineInjectable({token:a,factory:a.\u0275fac})}}return a})(),lt=(()=>{class a extends P.$z{constructor(){super(),this._apiService=(0,o.inject)(Y),this._convertor=(0,o.inject)(Q),this._currentPackageService=(0,o.inject)(at),this._serverClientOperationNotificationReceiver=(0,o.inject)(P.kN),this._copilotIntentChangedSubscribe()}_copilotIntentChangedSubscribe(){this._serverClientOperationNotificationReceiver.getNotifications("CopilotIntentChanged").subscribe(t=>this.deleteFromCache(t.intentUId))}_normalizeUId(t){return t.toLocaleLowerCase()}_getIntentSchema(t){return this._apiService.getSchema({schemaUId:t,useFullHierarchy:!0}).pipe((0,l.map)(s=>{if(!s.success)throw new Error(s.errorInfo?.message||`Failed to get schema with UId: ${t}`);return s.schema}),(0,l.shareReplay)({bufferSize:1,refCount:!1}),(0,l.catchError)(s=>(0,l.throwError)(()=>s)))}setToCache(t,s){super.setToCache(this._normalizeUId(t),s)}getFromCache(t){return super.getFromCache(this._normalizeUId(t))}deleteFromCache(t){return super.deleteFromCache(this._normalizeUId(t))}get(t){let s=this.getFromCache(t);return s||(s=this._getIntentSchema(t),this.setToCache(t,s)),s.pipe((0,l.map)(n=>this._convertor.schemaToModel(t,n)))}update(t){return this.getFromCache(t.UId).pipe((0,l.map)(s=>this._convertor.mapModelToSchema(s,t)),(0,l.switchMap)(s=>this._apiService.saveSchema(s)),(0,l.tap)(s=>{s.success||this.deleteFromCache(t.UId)}))}create(t){return this._currentPackageService.getDesignPackageUId(null).pipe((0,l.switchMap)(s=>this._apiService.createSchema({packageUId:s.uId,extendParent:!1,schemaUId:t})),(0,l.map)(s=>s.schema),(0,l.tap)(s=>this.setToCache(t,(0,l.of)(s))),(0,l.map)(s=>this._convertor.schemaToModel(t,s)))}static{this.\u0275fac=function(s){return new(s||a)}}static{this.\u0275prov=o.\u0275\u0275defineInjectable({token:a,factory:a.\u0275fac})}}return a})(),U=class ye{static{this.\u0275fac=function(t){return new(t||ye)}}static{this.\u0275mod=o.\u0275\u0275defineNgModule({type:ye})}static{this.\u0275inj=o.\u0275\u0275defineInjector({providers:[{provide:R.pk,useClass:lt},{provide:Y,useFactory:e=>{const t=o.Injector.create({name:"CopilotIntentSchemaDesignerApiInjector",parent:e,providers:[et("CopilotIntentSchemaDesignerService.svc"),{provide:Pe,useClass:Q,deps:[d.oqB]},{provide:Me,useValue:!0}]});return new Y(t)},deps:[o.Injector]},Q],imports:[H.CommonModule,q]})}};U=(0,h.Cg)([(0,c.CrtModule)({})],U),function(){(typeof ngJitMode>"u"||ngJitMode)&&o.\u0275\u0275setNgModuleScope(U,{imports:[H.CommonModule,q]})}();var u=C(73308);let W=class{constructor(e){this._intentSchemaManager=e}convert(e,t,s){var n=this;return(0,u.A)(function*(){const i=e.map(function(){var p=(0,u.A)(function*(S){return yield S[s]});return function(S){return p.apply(this,arguments)}}()),r=yield Promise.all(i);return(0,l.lastValueFrom)(n._intentSchemaManager.generateActionCode(r))})()}};W=(0,h.Cg)([(0,c.CrtConverter)({type:"crt.GenerateCopilotActionCode"}),(0,h.Sn)("design:paramtypes",[R.RL])],W);var dt=C(38628),K=C(38493),A=C(62441);let Ue=class extends c.BaseRequest{};Ue=(0,h.Cg)([(0,c.CrtRequest)({type:"crt.CopilotSayRequest"})],Ue);var M=function(a){return a.Assistant="assistant",a.User="user",a}(M||{});let we=class extends c.BaseRequest{};we=(0,h.Cg)([(0,c.CrtRequest)({type:"crt.CopilotRestartSessionRequest"})],we);class He{static get photo(){return"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGcgaWQ9Ikljb24gfCBBSSBDb3BpbG90IC0gMTZ4MTYgfCBoZWF2eSI+CjxwYXRoIGlkPSJVbmlvbiIgZmlsbC1ydWxlPSJldmVub2RkIiBjbGlwLXJ1bGU9ImV2ZW5vZGQiIGQ9Ik0xIDhDMSA3LjQxNTk2IDEuMDcxNTMgNi44NDg2MiAxLjIwNjMgNi4zMDYyN0wyLjY0ODM2IDcuMTEwNUMyLjYwMDYyIDcuMzk5OTIgMi41NzU3OCA3LjY5NzA2IDIuNTc1NzggOEMyLjU3NTc4IDEwLjk5NTcgNS4wMDQyOSAxMy40MjQyIDggMTMuNDI0MkM5LjY2MTgyIDEzLjQyNDIgMTEuMTQ5MSAxMi42NzY5IDEyLjE0NDEgMTEuNUgxNC4wNjM1QzEyLjg1MzIgMTMuNTkyMyAxMC41OTEgMTUgOCAxNUM0LjEzNDAxIDE1IDEgMTEuODY2IDEgOFpNOCAyLjU3NTc4QzkuNjYxODIgMi41NzU3OCAxMS4xNDkxIDMuMzIzMSAxMi4xNDQxIDQuNUgxNC4wNjM1QzEyLjg1MzIgMi40MDc3IDEwLjU5MSAxIDggMUM2LjU1MDc3IDEgNS4yMDQ0IDEuNDQwNDEgNC4wODc0MyAyLjE5NDY4TDYuMzMzNzggMi44MzY1QzYuODU4NzcgMi42NjcyMiA3LjQxODcgMi41NzU3OCA4IDIuNTc1NzhaTTcuMTI1IDExLjA2MjVMMTUgOEwxIDIuNzVMOC40Mzc1IDhMNy4xMjUgMTEuMDYyNVoiIGZpbGw9IiMwRDJFNEUiLz4KPC9nPgo8L3N2Zz4K"}static get title(){return"Copilot"}static get contact(){return{photo:this.photo,name:this.title}}}let De=class extends c.BaseRequest{};De=(0,h.Cg)([(0,c.CrtRequest)({type:"crt.CopilotExecuteIntentRequest"})],De);let Le=class extends c.BaseRequest{};Le=(0,h.Cg)([(0,c.CrtRequest)({type:"crt.CopilotGetAvailableIntentsRequest"})],Le);var pt=function(a){return a.ExecutedSuccessfully="ExecutedSuccessfully",a.CantGenerateGoodResponse="CantGenerateGoodResponse",a.FailedToExecute="FailedToExecute",a.ResponseParsingFailed="ResponseParsingFailed",a.IntentNotFound="IntentNotFound",a.InactiveIntent="InactiveIntent",a.WrongIntentMode="WrongIntentMode",a.InsufficientPermissions="InsufficientPermissions",a}(pt||{}),z=C(86731);let Z=(()=>{class a{constructor(t,s){this._featureValues=t,this._translateService=s}_getAuthorByRole(t,s){return t===M.Assistant?He.contact:null}_getIsBotMessage(t){return t===M.Assistant}_getMessageDirection(t){return t===M.User?K.MessageDirection.Outcoming:K.MessageDirection.Incoming}_addCopilotMessageActions(t){t.actions=[{caption:this._translateService.instant("Conversation.Copilot.Action.Replace"),type:d.Uhu.Replace},{caption:this._translateService.instant("Conversation.Copilot.Action.InsertAbove"),type:d.Uhu.InsertAbove},{caption:this._translateService.instant("Conversation.Copilot.Action.InsertBelow"),type:d.Uhu.InsertBelow}]}convertMessages(t,s){return t.filter(n=>(n.role===M.Assistant||n.role===M.User)&&!(0,A.A)(n.content)).map(n=>{const i=n.createdOnTicks*1e-4,r={text:n.content,type:dt.X8Y.Text,date:new Date(i),isBotMessage:!0,id:n.id};return r.author=this._getAuthorByRole(n.role,s),r.isBotMessage=this._getIsBotMessage(n.role),r.direction=this._getMessageDirection(n.role),this._featureValues.SelectionRewriteActions&&r.direction===K.MessageDirection.Incoming&&r.isBotMessage&&this._addCopilotMessageActions(r),r})}static{this.\u0275fac=function(s){return new(s||a)(o.\u0275\u0275inject(d.G2Y),o.\u0275\u0275inject(z.c$))}}static{this.\u0275prov=o.\u0275\u0275defineInjectable({token:a,factory:a.\u0275fac})}}return a})(),Ve=class extends c.BaseRequest{};Ve=(0,h.Cg)([(0,c.CrtRequest)({type:"crt.GenerateCopilotActionCodeValueRequest"})],Ve);let X=class extends c.BaseRequestHandler{constructor(e){super(),this.injector=e,this._cacheAttributeName="_ActionCodes_Cache",this._initialCodeValueAttributeName="_InitialCodeValue",this._intentManager=this.injector.get(R.RL)}_getActionCodes(e,t){var s=this;return(0,u.A)(function*(){const n=yield e[s._cacheAttributeName];if(n?.length>0)return(0,l.of)(n);const i=yield e[t];return s._intentManager.getIntent(i?.value).pipe((0,l.map)(r=>r.Actions.map(p=>p.Code)),(0,l.tap)(r=>e[s._cacheAttributeName]=r))})()}handle(e){var t=this;return(0,u.A)(function*(){const s=e.$context;if(s.PrimaryModelMode!==d.btv.Create){yield t.next?.handle(e);return}let n=yield s[t._initialCodeValueAttributeName];n||(n=yield s[e.codeAttributeName],s[t._initialCodeValueAttributeName]=n);const i=yield s[e.valueAttributeName];if(!i){s[e.codeAttributeName]=n;return}const r=(yield t._getActionCodes(s,e.intentAttributeName)).pipe((0,l.switchMap)(p=>t._intentManager.generateActionCode(p,i)));s[e.codeAttributeName]=(yield(0,l.lastValueFrom)(r))??(yield s[t._initialCodeValueAttributeName]),yield t.next?.handle(e)})()}};X=(0,h.Cg)([(0,c.CrtRequestHandler)({type:"crt.GenerateCopilotActionCodeValueHandler",requestType:"crt.GenerateCopilotActionCodeValueRequest"}),(0,h.Sn)("design:paramtypes",[o.Injector])],X);const v={process:"ProcessSchemaUId",params:"PDS_Params"},ee="CopilotChatInitMessagesSubscriptions",ke="NavigationStateIsLoading",te="CurrentPageSchemaName",ze="CopilotIntents",Fe="CopilotIntentPageQuickLinks",ht="CopilotQuickActions";let se=class extends c.BaseRequestHandler{constructor(e){super(),this._customEventService=e}_getModelInitConfig(e){return(0,u.A)(function*(){const t=e.modelInitConfigs,s=yield e.getPrimaryModelName();return t?.find(n=>n.name===s)})()}handle(e){var t=this;return(0,u.A)(function*(){const s=e.$context;s[v.process]=null;const n=yield t.next?.handle(e);if((yield t._getModelInitConfig(s))?.action===c.ModelInPageAction.Add)return n;const p=yield s.ProcessDesignerInstanceId;return yield new Promise(S=>{const m={designerInstanceId:p,callback:S};t._customEventService.createOutboundChannel("cancelProcessSchemaChanges").next(m)}),n})()}};se=(0,h.Cg)([(0,c.CrtRequestHandler)({requestType:"crt.CancelRecordChangesRequest",type:"crt.CopilotProcessActionsCancelRecordHandler",scopes:["CopilotProcessActions_FormPage"]}),(0,h.Sn)("design:paramtypes",[T.CustomEventService])],se);let ne=class extends c.BaseRequestHandler{constructor(e,t){super(),this._customEventService=e,this._translateService=t}_performDesignerSave(e,t){var s=this;return(0,u.A)(function*(){const n=yield e.ProcessDesignerInstanceId;return new Promise(i=>{const r={designerInstanceId:n,needSaveNewVersion:t,saveCallback:i};s._customEventService.createOutboundChannel("saveProcessSchema").next(r)})})()}_showDesignerValidationErrorNotification(e){var t=this;return(0,u.A)(function*(){const n=yield(0,l.lastValueFrom)(t._translateService.get("Dialog.ProcessSchemaSavedWithValidationError")),i={type:"crt.NotificationRequest",$context:e,message:n,translate:!1};yield t.handlerChain.process(i)})()}handle(e){var t=this;return(0,u.A)(function*(){const s=e.$context,n=e.config,i=n?n.needSaveNewVersion:!1;if(!(yield s.isValid()))return yield t.next?.handle(e);const p=yield t._performDesignerSave(s,i);return p.isCanceled?!1:(p.isValid||(yield t._showDesignerValidationErrorNotification(s)),yield t.next?.handle(e))})()}};ne=(0,h.Cg)([(0,c.CrtRequestHandler)({requestType:"crt.SaveRecordRequest",type:"crt.CopilotProcessActionsPageSaveHandler",scopes:["CopilotProcessActions_FormPage"]}),(0,h.Sn)("design:paramtypes",[T.CustomEventService,z.c$])],ne);function $e(a){return ae.apply(this,arguments)}function ae(){return ae=(0,u.A)(function*(a){const e="ProcessDesignerInstanceId";let t=yield a[e];t||(t=(0,c.generateGuid)(),a[e]=t)}),ae.apply(this,arguments)}let ie=class extends c.BaseRequestHandler{_subscribeParamsLoaded(e){const t=new l.Subscription;t.add(e.events$.pipe((0,l.filter)(({type:s})=>s==="finish-load-model-attributes"),(0,l.filter)(({payload:s})=>s[v.params]),(0,l.switchMap)(()=>e[v.params]),(0,l.filter)(s=>!!s)).subscribe({next:function(){var s=(0,u.A)(function*(n){let i;try{i=JSON.parse(n).processSchemaUId}catch(S){console.error(`params = ${n}
${S?.message}`)}const r={silent:!0},p={[v.process]:i};e.setValue(p,r),yield $e(e)});return function(i){return s.apply(this,arguments)}}(),complete:()=>{t.unsubscribe()}}))}handle(e){var t=this;return(0,u.A)(function*(){yield t.next?.handle(e),t._subscribeParamsLoaded(e.$context)})()}};ie=(0,h.Cg)([(0,c.CrtRequestHandler)({type:"crt.CopilotProcessActionsPageInitHandler",requestType:"crt.HandleViewModelInitRequest",scopes:["CopilotProcessActions_FormPage"]})],ie);var E=C(85970);let re=class extends c.BaseRequestHandler{constructor(){super(...arguments),this._statusFlags=["ProcessSchemaIsChanged","HasUnsavedData",E.j7k,v.process]}_handleProcessChange(e){if(e.attributeName===v.process&&!e.silent){const t={processSchemaUId:e.value};e.$context[v.params]=JSON.stringify(t)}}_handleCreateModel(e){return(0,u.A)(function*(){e.attributeName===E.yMl&&e.value===d.btv.Create&&(e.$context[v.process]=c.EMPTY_GUID,yield $e(e.$context))})()}handle(e){var t=this;return(0,u.A)(function*(){if(t._handleProcessChange(e),yield t._handleCreateModel(e),e.attributeName==="ProcessSchemaIsLoaded"&&e.value){const s=yield e.$context.getPrimaryModelName();e.$context.getModelByName(s).setLoadedState()}else if(t._statusFlags.includes(e.attributeName)){const s=yield e.$context[v.process],n=yield e.$context.ProcessSchemaIsLoaded,i=yield e.$context.ProcessSchemaIsChanged,r=yield e.$context.HasUnsavedData,p=yield e.$context.IsChanged;e.$context.ProcessActionHasUnsavedData=n&&s!==c.EMPTY_GUID&&(r||p||i)}return t.next?.handle(e)})()}};re=(0,h.Cg)([(0,c.CrtRequestHandler)({type:"crt.CopilotProcessActionsPageAttributeChangeHandler",requestType:"crt.HandleViewModelAttributeChangeRequest",scopes:["CopilotProcessActions_FormPage"]})],re);var ut=C(52208),Ge=C(80759);const mt="CopilotMsgChannelSender",gt="CopilotChatPart";let w=(()=>{class a{constructor(t,s,n,i){this._httpClient=t,this._messageChannelService=s,this._contextSchemaService=n,this._featureValues=i,this._apiUrl="/rest/CopilotService",this._copilotSession=null;const r=this._featureValues??{};this._isNeedToAddConsoleLog=!!r.ShowSystemMessagesFromCopilot}getInitialMessages$(){return this._loadInitialMessages()}copilotMessageEvent$(){return this._messageChannelService.messageEvent$.pipe((0,l.filter)(t=>t.header.sender===mt&&t.header.bodyTypeName===gt),(0,l.map)(t=>t.body.messages),(0,l.tap)(t=>{this._isNeedToAddConsoleLog&&(console.group("Copilot"),console.log(t),console.groupEnd())}))}_loadInitialMessages(){return this._getActiveCopilotSessions().pipe((0,l.mergeMap)(t=>this._handleActiveCopilotSessions(t).pipe((0,O.W)(s=>(console.error(s),(0,l.of)([]))))))}_handleActiveCopilotSessions(t){return t.length>0?(this._copilotSession=t[0],this._getCopilotSessionMessages(this._copilotSession.id)):(0,l.throwError)(()=>new Error("No active copilot sessions found"))}_getActiveCopilotSessions(){return this._httpClient.post(`${this._apiUrl}/GetActiveCopilotSessions`,{}).pipe((0,l.map)(t=>t.copilotSessions))}_getCopilotSessionMessages(t){return this._httpClient.post(`${this._apiUrl}/GetCopilotSessionMessage`,{copilotSessionId:t}).pipe((0,l.map)(s=>s.copilotMessages))}_sendUserMessage(t){return(0,l.from)(this._contextSchemaService.getContext()).pipe((0,l.switchMap)(s=>this._httpClient.post(`${this._apiUrl}/SendUserMessage`,{content:t,copilotContext:{parts:s||[]},copilotSessionId:this._copilotSession?.id})),(0,l.map)(s=>s?.copilotChatPart))}_closeCopilotSession(){return this._httpClient.post(`${this._apiUrl}/CloseSession`,{copilotSessionId:this._copilotSession?.id}).pipe((0,O.W)(t=>(0,l.throwError)(()=>new Error(`Server return status: ${t.status}`))))}sayWithResponse(t){var s=this;return(0,u.A)(function*(){const n=yield(0,l.firstValueFrom)(s._sendUserMessage(t));return n&&(0,A.A)(n.errorCode)&&(0,A.A)(n.errorMessage)&&(s._copilotSession=n.copilotSession),n})()}closeSession(){var t=this;return(0,u.A)(function*(){if(!t._copilotSession?.id)return Promise.reject("No active session");try{yield(0,l.firstValueFrom)(t._closeCopilotSession()),t._copilotSession=null}catch(s){return Promise.reject(`Server return status: ${s.status}`)}})()}static{this.\u0275fac=function(s){return new(s||a)(o.\u0275\u0275inject(y.HttpClient),o.\u0275\u0275inject(d.Awl),o.\u0275\u0275inject(Ge.ex),o.\u0275\u0275inject(d.G2Y,8))}}static{this.\u0275prov=o.\u0275\u0275defineInjectable({token:a,factory:a.\u0275fac,providedIn:"root"})}}return a})(),oe=(()=>{class a{constructor(t){this._httpClient=t,this._executeIntentUrl="/rest/CopilotService/ExecuteIntent",this._getAvailableIntentsUrl="/rest/CopilotService/GetAvailableIntents"}_executeIntent(t,s,n){const i=n?Object.entries(n).map(([p,S])=>({Key:p,Value:S})):[],r={intentName:t,additionalPromptText:s,parameters:i};return this._httpClient.post(this._executeIntentUrl,r).pipe((0,O.W)(p=>(0,l.throwError)(()=>new Error(`Server return status: ${p.status}`))))}_getAvailableIntents(t,s){const n={names:t},i=this._getAvailableIntentsUrl+`/?mode=${s}`;return this._httpClient.post(i,n).pipe((0,O.W)(r=>(0,l.throwError)(()=>new Error(`Server return status: ${r.status}`))))}executeIntent(t,s,n){var i=this;return(0,u.A)(function*(){try{return yield(0,l.firstValueFrom)(i._executeIntent(t,s,n))}catch(r){const p=r.status?`Server return status: ${r.status}`:`${r}`;return Promise.reject(p)}})()}getAvailableIntents(t,s){var n=this;return(0,u.A)(function*(){s||(s="API");try{return yield(0,l.firstValueFrom)(n._getAvailableIntents(t,s))}catch(i){const r=i.status?`Server return status: ${i.status}`:`${i}`;return Promise.reject(r)}})()}static{this.\u0275fac=function(s){return new(s||a)(o.\u0275\u0275inject(y.HttpClient))}}static{this.\u0275prov=o.\u0275\u0275defineInjectable({token:a,factory:a.\u0275fac,providedIn:"root"})}}return a})(),ce=class extends c.BaseRequestHandler{constructor(e,t,s,n){super(),this._copilotChatService=e,this._crtRouter=t,this._userInfo=s,this._injector=n,this.userConsentService=n.get(P.FX),this._copilotToChatConvertor=n.get(Z)}_getConvertedMessages(e){return this._copilotToChatConvertor.convertMessages(e,{id:this._userInfo.contactId,name:this._userInfo.contactName,photoId:this._userInfo.photoId})}_initUserConsentData(e){this.userConsentService.getConsent("CopilotLegalNotice").subscribe(t=>{t&&(e.CopilotDisclaimer=t.consentText,this.userConsentService.getUserConsent(t.id).subscribe(s=>{e.IsCopilotChatVisible=s!==null,e.IsCopilotDisclaimerVisible=s===null}))})}_initWatchNavigation(e){var t=this;return(0,u.A)(function*(){const s=t._crtRouter.navigateStart$.pipe((0,l.tap)(()=>e[ke]=!0)).subscribe(),n=t._crtRouter.navigateEnd$.pipe((0,l.tap)((0,u.A)(function*(){e[ke]=!1;const i=yield(0,l.firstValueFrom)(t._crtRouter.crtRoute$);e[te]=i?.state?.schemaName}))).subscribe();yield t._addToSubscriptions(e,[s,n])})()}_addToSubscriptions(e,t){return(0,u.A)(function*(){const s=(yield e[ee])??[];e[ee]=s,s.push(...t)})()}handle(e){var t=this;return(0,u.A)(function*(){yield t.next?.handle(e);const s=e.$context;e.$context.ChatMessages=t._getConvertedMessages(yield(0,l.lastValueFrom)(t._copilotChatService.getInitialMessages$()));const n=t._copilotChatService.copilotMessageEvent$().subscribe(i=>{e.$context.ChatMessages=t._getConvertedMessages(i)});yield t._addToSubscriptions(s,[n]),e.$context.CopilotContact=He.contact,t._initUserConsentData(e.$context),yield t._initWatchNavigation(s)})()}};ce=(0,h.Cg)([(0,c.CrtRequestHandler)({type:"crt.CopilotChatInitHandler",requestType:"crt.HandleViewModelInitRequest",scopes:["CopilotPanel"]}),(0,h.Sn)("design:paramtypes",[w,ut.fH,d.oqB,o.Injector])],ce);let Be=class extends c.BaseRequestHandler{constructor(){super()}handle(e){var t=this;return(0,u.A)(function*(){const n=yield e.$context[ee];if(Array.isArray(n))for(const i of n)i?.unsubscribe();yield t.next?.handle(e)})()}};Be=(0,h.Cg)([(0,c.CrtRequestHandler)({type:"crt.CopilotChatDestroyHandler",requestType:"crt.HandleViewModelDestroyRequest",scopes:["CopilotPanel"]}),(0,h.Sn)("design:paramtypes",[])],Be);let le=class extends c.BaseRequestHandler{constructor(e){super(),this._userConsentService=e.get(P.FX)}handle(e){var t=this;return(0,u.A)(function*(){t._userConsentService.giveUserConsent(e.consentCode).subscribe(()=>{e.$context.IsCopilotChatVisible=!0,e.$context.IsCopilotDisclaimerVisible=!1}),yield t.next?.handle(e)})()}};le=(0,h.Cg)([(0,c.CrtRequestHandler)({type:"crt.CopilotDisclaimerAcceptHandler",requestType:"crt.CopilotDisclaimerAcceptRequest",scopes:["CopilotPanel"]}),(0,h.Sn)("design:paramtypes",[o.Injector])],le);let de=class extends c.BaseRequestHandler{constructor(){super(...arguments),this._watchAttributes=[te,ze,Fe]}_actualizeCopilotQuickActions(e){var t=this;return(0,u.A)(function*(){const s=yield e[ht],n=(yield e[ze])??[],i=yield e[Fe];if(!Array.isArray(n)||n.length===0||!Array.isArray(i)||i.length===0)return;yield s.clear();const r=yield e[te],S=(yield Promise.all(i.map(function(){var g=(0,u.A)(function*(I){return{pageName:yield I.PageName,intentCode:yield I.IntentCode}});return function(I){return g.apply(this,arguments)}}()))).filter(g=>t._isPatternMatch(g.pageName,r)).map(g=>g.intentCode),m=[];for(const g of n){const I=yield g.Code;t._hasMatchingPattern(S,I)&&m.push(g)}yield s.reload(m)})()}_hasMatchingPattern(e,t){return e.some(s=>this._isPatternMatch(s,t))}_isPatternMatch(e,t){t=`${t}`.trim().toLowerCase(),e=`${e}`.trim().toLowerCase();const[s]=e.split("*").filter(Boolean);return e==="*"?!0:e.startsWith("*")?t.endsWith(s):e.endsWith("*")?t.startsWith(s):e===t}handle(e){var t=this;return(0,u.A)(function*(){const s=e.$context;if(t._watchAttributes.includes(e.attributeName))return yield t._actualizeCopilotQuickActions(s),t.next?.handle(e)})()}};de=(0,h.Cg)([(0,c.CrtRequestHandler)({type:"crt.CopilotActualizeIntentQuickLinksHandler",requestType:"crt.HandleViewModelAttributeChangeRequest",scopes:["CopilotPanel"]})],de);var Ct=C(27643);class N{static{this.errorCodeGroups={AuthorizationError:["MissingApiKey","InvalidApiKey","Unauthorized","UnauthorizedClient","InvalidScope","InvalidGrantType"],FormatError:["InvalidRequest","InvalidJson","NoEntities"],LimitError:["RateLimitReached","InsufficientQuota","QuotaExceeded","InternalQuotaExceeded","LimitExceeded"],ServiceAvailabilityError:["ServiceUnavailable","ServerNotAvailable","EngineOverloaded","ServerError","RequestTimeout","NetworkError"],ExecutionError:["ActionExecutionFailed","InvalidResponse"],ConfigurationError:["InvalidUri","ModelNotFound","ModelError","IncorrectConfiguration"],UnknownError:["Unknown","UnknownError"]}}static{this.errorCodeToGroup=N._populateErrorCodeToGroupMap()}static getErrorMessageKey(e){return`MessageEditor.ErrorCode.${N.errorCodeToGroup[e]||"UnknownError"}`}static _populateErrorCodeToGroupMap(){const e={};return Object.keys(N.errorCodeGroups).forEach(t=>{for(const s of N.errorCodeGroups[t])e[s]=t}),e}}let Je=(()=>{class a extends w{constructor(t,s,n,i,r,p,S){super(t,s,n,i),this._copilotChatService=r,this._notifyService=p,this._translateService=S}_getCurrentUserTime(){return new Date().getTime()*1e4+621355968e9}_sendErrorMessageToChat(t,s){var n=this;return(0,u.A)(function*(){if(!t)return;const i=N.getErrorMessageKey(s??""),r={id:(0,c.generateGuid)(),createdOnTicks:n._getCurrentUserTime(),content:n._translateService.instant(i),role:M.Assistant,isSaved:!0};t?.messages?.push(r)})()}_notifyUser(t){var s=this;return(0,u.A)(function*(){const n=N.getErrorMessageKey(t??"");yield s._notifyService.error({message:n})})()}sayWithResponse(t){var s=this;return(0,u.A)(function*(){let n;try{n=yield s._copilotChatService.sayWithResponse(t);const i=n?.errorCode;return i&&(yield s._sendErrorMessageToChat(n,i),yield s._notifyUser(i)),n}catch(i){yield s._sendErrorMessageToChat(n),yield s._notifyUser(),console.error(i)}})()}static{this.\u0275fac=function(s){return new(s||a)(o.\u0275\u0275inject(y.HttpClient),o.\u0275\u0275inject(d.Awl),o.\u0275\u0275inject(Ge.ex),o.\u0275\u0275inject(d.G2Y,8),o.\u0275\u0275inject(w),o.\u0275\u0275inject(Ct.FL),o.\u0275\u0275inject(z.c$))}}static{this.\u0275prov=o.\u0275\u0275defineInjectable({token:a,factory:a.\u0275fac,providedIn:"root"})}}return a})();class qe extends c.BaseRequestHandler{constructor(e){super(),this._copilotChatService=e.get(Je)}_setTypingVisible(e,t){e.$context.IsTyping=t}handle(e){var t=this;return(0,u.A)(function*(){const s=e;t._setTypingVisible(s,!0);const n=yield t._copilotChatService.sayWithResponse(s.prompt);return t._setTypingVisible(s,!1),n})()}}let pe=class extends qe{constructor(e){super(e),this._userInfo=e.get(d.oqB),this._copilotToChatConvertor=e.get(Z)}_getConvertedMessages(e){return this._copilotToChatConvertor.convertMessages(e,{id:this._userInfo.contactId,name:this._userInfo.contactName,photoId:this._userInfo.photoId})}_addMessageToConversation(e,t,s){e.$context[s]=this._getConvertedMessages(t)}handle(e){var t=()=>super.handle,s=this;return(0,u.A)(function*(){const n=e.attributesMapping,i=n?.chatInput;if(!(0,A.A)(i)){const r=yield e.$context[i];e.$context[i]="";const p=yield t().call(s,Object.assign(e,{prompt:r}));if(!p)e.$context[i]=r;else if(p?.messages.length){const S=n?.chatMessages;(0,A.A)(S)||s._addMessageToConversation(e,p.messages,S)}}yield s.next?.handle(e)})()}};pe=(0,h.Cg)([(0,c.CrtRequestHandler)({type:"crt.CopilotMessageEditorSendHandler",requestType:"crt.MessageEditorSendRequest",scopes:["CopilotPanel"]}),(0,h.Sn)("design:paramtypes",[o.Injector])],pe);var St=C(98980);let he=class extends c.BaseRequestHandler{constructor(e){super(),this._copilotChatService=e.get(w),this._copilotToEditorCommunicationService=e.get(d.iKh)}handle(e){var t=this;return(0,u.A)(function*(){yield t._copilotChatService.closeSession();const s=e.chatMessagesAttributeName,n=e.conversationEventAttributeName;!(0,A.A)(s)&&!(0,A.A)(n)&&(e.$context[s]=[],e.$context[n]=[{name:St.CONVERSATION_RESET_EVENT}]),t._copilotToEditorCommunicationService.notify({editorAction:d.uB4.RemoveHighlighting}),yield t.next?.handle(e)})()}};he=(0,h.Cg)([(0,c.CrtRequestHandler)({type:"crt.CopilotRestartSessionHandler",requestType:"crt.CopilotRestartSessionRequest",scopes:["CopilotPanel"]}),(0,h.Sn)("design:paramtypes",[o.Injector])],he);let ue=class extends c.BaseRequestHandler{constructor(e){super(),this.injector=e,this._intentManager=this.injector.get(R.RL)}_getModelInitConfig(e){return(0,u.A)(function*(){const t=e.modelInitConfigs,s=yield e.getPrimaryModelName();return t?.find(n=>n.name===s)})()}_getIntent(e,t){var s=this;return(0,u.A)(function*(){let n;const r=(yield e.getPrimaryDataSchema())?.name;return r==="CopilotIntent"?n=yield(0,l.firstValueFrom)(s._intentManager.getIntent(t)):r==="CopilotAction"&&(n=yield(0,l.firstValueFrom)(s._intentManager.getIntentByActionUId(t))),n})()}_disableCodeField(e){const t=e.getAttributeNameByViewItemName("Code");e.disableAttributeValidator(t,"CodePrefixValidator"),e.setAttributePropertyValue(t,"readonly",!0)}handle(e){var t=this;return(0,u.A)(function*(){yield t.next?.handle(e);const s=e.$context,n=yield t._getModelInitConfig(s);if(!(n?.action===c.ModelInPageAction.Edit))return;(yield t._getIntent(s,n?.recordId))?.ExtendParent&&t._disableCodeField(s)})()}};ue=(0,h.Cg)([(0,c.CrtRequestHandler)({type:"crt.CopilotPageDisableCodeFieldHandler",requestType:"crt.HandleViewModelInitRequest",scopes:["CopilotIntents_FormPage","CopilotProcessActions_FormPage"]}),(0,h.Sn)("design:paramtypes",[o.Injector])],ue);let me=class extends qe{constructor(e){super(e)}handle(e){var t=()=>super.handle,s=this;return(0,u.A)(function*(){yield s.handlerChain.process({type:"crt.OpenSidebarRequest",sidebarCode:"Copilot",$context:e.$context}),yield t().call(s,e),yield s.next?.handle(e)})()}};me=(0,h.Cg)([(0,c.CrtRequestHandler)({type:"crt.CopilotActionRequestHandler",requestType:"crt.CopilotActionRequest"}),(0,h.Sn)("design:paramtypes",[o.Injector])],me);var It=C(91791);let ge=class extends c.BaseRequestHandler{constructor(e){super(),this._broadcastChannelFactory=e,this._init()}_init(){this._workspaceReloadBroadcastService=this._broadcastChannelFactory.createInstance(It.ou)}handle(e){var t=this;return(0,u.A)(function*(){const s=yield t.next?.handle(e);return t._workspaceReloadBroadcastService.publish(),s})()}};ge=(0,h.Cg)([(0,c.CrtRequestHandler)({type:"crt.CopilotIntentSaveHandler",requestType:"crt.SaveRecordRequest",scopes:["CopilotIntents_FormPage"]}),(0,h.Sn)("design:paramtypes",[T.BroadcastChannelFactory])],ge);let Ce=class extends c.BaseRequestHandler{constructor(e){super(),this._copilotService=e.get(oe)}handle(e){var t=this;return(0,u.A)(function*(){const s=yield t._copilotService.executeIntent(e.intentName,e.additionalPromptText,e.parameters);return yield t.next?.handle(e),s})()}};Ce=(0,h.Cg)([(0,c.CrtRequestHandler)({type:"crt.CopilotExecuteIntentHandler",requestType:"crt.CopilotExecuteIntentRequest"}),(0,h.Sn)("design:paramtypes",[o.Injector])],Ce);let Se=class extends c.BaseRequestHandler{constructor(){super(...arguments),this._apiMode=E.$E4.get(E.aAW.Api)}handle(e){var t=this;return(0,u.A)(function*(){if(e.attributeName==="PDS_Mode"){const s=e.value?e.value:yield e.$context.PDS_Mode;e.$context.IsApiMode=s?s.value===t._apiMode:!1}return t.next?.handle(e)})()}};Se=(0,h.Cg)([(0,c.CrtRequestHandler)({type:"crt.CopilotIntentModeChangeHandler",requestType:"crt.HandleViewModelAttributeChangeRequest",scopes:["CopilotIntents_FormPage"]})],Se);var ft=C(57306);let Ie=class extends c.BaseRequestHandler{constructor(e){super(),this._copilotPanelCode="Copilot",this._sidebarStateService=e.get(ft.pd),this._copilotChatService=e.get(Je),this._translateService=e.get(z.c$),this._copilotToEditorCommunicationService=e.get(d.iKh)}_getPrompt(e,t){return["Friendly","Formal","Shorten","Extend","Rephrase","AskCopilot"].includes(t)?`${this._translateService.instant(`Copilot.RewriteActionsPrompt.${t}`)}: ${e}`:e}handle(e){var t=this;return(0,u.A)(function*(){const s=yield e.$context[e.selectionAttributeName];if(!(0,A.A)(s)){t._copilotToEditorCommunicationService.notify({editorAction:d.uB4.SetHighlighting,selection:s});const n=t._getPrompt(s,e.rewriteAction);yield t._sidebarStateService.openRootSidebar(t._copilotPanelCode),yield t._copilotChatService.sayWithResponse(n)}yield t.next?.handle(e)})()}};Ie=(0,h.Cg)([(0,c.CrtRequestHandler)({type:"crt.CopilotRewriteTextHandler",requestType:"crt.SelectionActionRequest",scopes:[E.MJm.AllCards,"BasePageFreedomTemplate","BaseSidebarTemplate",E.MJm.AllSections]}),(0,h.Sn)("design:paramtypes",[o.Injector])],Ie);let fe=class extends c.BaseRequestHandler{constructor(e){super(),this._copilotService=e.get(oe)}_isObjectResponse(e){return!!e&&e===Object(e)&&!Array.isArray(e)}handle(e){var t=this;return(0,u.A)(function*(){const s=yield t._copilotService.getAvailableIntents(e.intentNames,e.mode),n=yield t.next?.handle(e);return t._isObjectResponse(n)?{...s,...n}:s})()}};fe=(0,h.Cg)([(0,c.CrtRequestHandler)({type:"crt.CopilotGetAvailableIntentsHandler",requestType:"crt.CopilotGetAvailableIntentsRequest"}),(0,h.Sn)("design:paramtypes",[o.Injector])],fe);var _t=C(68642);let _e=class extends c.BaseRequestHandler{constructor(e){super(),this._copilotPanelCode="Copilot",this._copilotToEditorCommunicationService=e.get(d.iKh)}handle(e){var t=this;return(0,u.A)(function*(){e.sidebarCode===t._copilotPanelCode&&t._copilotToEditorCommunicationService.notify({editorAction:d.uB4.RemoveHighlighting,selection:_t.Qf.empty}),yield t.next?.handle(e)})()}};_e=(0,h.Cg)([(0,c.CrtRequestHandler)({type:"crt.CopilotClosePanelHandler",requestType:"crt.HandleSidebarCloseRequest"}),(0,h.Sn)("design:paramtypes",[o.Injector])],_e);let ve=class extends c.BaseRequestHandler{constructor(e){super(),this._copilotToEditorCommunicationService=e.get(d.iKh)}handle(e){var t=this;return(0,u.A)(function*(){t._copilotToEditorCommunicationService?.notify({editorAction:d.uB4.RemoveHighlighting}),yield t.next?.handle(e)})()}};ve=(0,h.Cg)([(0,c.CrtRequestHandler)({type:"crt.CopilotViewModelPauseHandler",requestType:"crt.HandleViewModelPauseRequest"}),(0,h.Sn)("design:paramtypes",[o.Injector])],ve);const vt={"hr-HR":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"bg-BG":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"hu-HU":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"zh-CN":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"uk-UA":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"sq-AL":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"zh-TW":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"no-NO":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),zh:JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"vi-VN":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"tr-TR":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"th-TH":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"sv-SE":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"ro-RO":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"pt-PT":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"pt-BR":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"pl-PL":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),no:JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"nl-NL":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"lv-LV":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"ko-KR":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"kk-KZ":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"ja-JP":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"it-IT":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"id-ID":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"he-IL":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"fr-FR":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"fr-CA":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"fa-IR":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"es-ES":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"de-DE":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"cs-CZ":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"ar-SA":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{}}}'),"en-US":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{"AskCopilot":"You will assist with rewriting the following text, further instructions will be provided in the dialog","Friendly":"Rewrite the following text and make it more friendly","Formal":"Rewrite the following text and make it more formal","Shorten":"Rewrite the following text and shorten it","Extend":"Rewrite the following text and extend it","Rephrase":"Rewrite the following text and rephrase it"}}}'),"ru-RU":JSON.parse('{"Copilot":{"RewriteActionsPrompt":{"AskCopilot":"\u0422\u044B \u0431\u0443\u0434\u0435\u0448\u044C \u043F\u043E\u043C\u043E\u0433\u0430\u0442\u044C \u043F\u0435\u0440\u0435\u043F\u0438\u0441\u044B\u0432\u0430\u0442\u044C \u0442\u0435\u043A\u0441\u0442, \u043F\u0440\u0438\u0432\u0435\u0434\u0435\u043D\u043D\u044B\u0439 \u043D\u0438\u0436\u0435, \u0434\u0430\u043B\u044C\u043D\u0435\u0439\u0448\u0438\u0435 \u0438\u043D\u0441\u0442\u0440\u0443\u043A\u0446\u0438\u0438 \u0431\u0443\u0434\u0443\u0442 \u0432 \u0434\u0438\u0430\u043B\u043E\u0433\u0435","Friendly":"\u041F\u0435\u0440\u0435\u043F\u0438\u0448\u0438 \u0442\u0435\u043A\u0441\u0442 \u043D\u0438\u0436\u0435 \u0438 \u0441\u0434\u0435\u043B\u0430\u0439 \u0435\u0433\u043E \u0431\u043E\u043B\u0435\u0435 \u0434\u0440\u0443\u0436\u0435\u043B\u044E\u0431\u043D\u044B\u043C","Formal":"\u041F\u0435\u0440\u0435\u043F\u0438\u0448\u0438 \u0442\u0435\u043A\u0441\u0442 \u043D\u0438\u0436\u0435 \u0438 \u0441\u0434\u0435\u043B\u0430\u0439 \u0435\u0433\u043E \u0431\u043E\u043B\u0435\u0435 \u0444\u043E\u0440\u043C\u0430\u043B\u044C\u043D\u044B\u043C","Shorten":"\u041F\u0435\u0440\u0435\u043F\u0438\u0448\u0438 \u0442\u0435\u043A\u0441\u0442 \u043D\u0438\u0436\u0435 \u0438 \u0443\u043A\u043E\u0440\u043E\u0442\u0438 \u0435\u0433\u043E","Extend":"\u041F\u0435\u0440\u0435\u043F\u0438\u0448\u0438 \u0442\u0435\u043A\u0441\u0442 \u043D\u0438\u0436\u0435 \u0438 \u0443\u0434\u043B\u0438\u043D\u0438 \u0435\u0433\u043E","Rephrase":"\u041F\u0435\u0440\u0435\u043F\u0438\u0448\u0438 \u0442\u0435\u043A\u0441\u0442 \u043D\u0438\u0436\u0435 \u0438 \u043F\u0435\u0440\u0435\u0444\u0440\u0430\u0437\u0438\u0440\u0443\u0439 \u0435\u0433\u043E"}}}')};let F=class Ae{static{this.\u0275fac=function(t){return new(t||Ae)}}static{this.\u0275mod=o.\u0275\u0275defineNgModule({type:Ae})}static{this.\u0275inj=o.\u0275\u0275defineInjector({providers:[P.FX,Z],imports:[R.EL,U,T.CrtLibTranslateModule.forRoot({i18n:vt})]})}};F=(0,h.Cg)([(0,c.CrtModule)({viewElements:[],requestHandlers:[me,ce,_e,ve,le,ge,pe,ue,se,re,ie,ne,Ie,he,X,Ce,Se,fe,de],converters:[W]})],F),function(){(typeof ngJitMode>"u"||ngJitMode)&&o.\u0275\u0275setNgModuleScope(F,{imports:[R.EL,U,T.CrtLibTranslateModule]})}()}}]);
